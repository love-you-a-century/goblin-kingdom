<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>哥布林王國v5.09</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=MedievalSharp&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>

<body class="p-4 md:p-6" x-data="game()">
    <div class="max-w-7xl mx-auto">

        <audio x-ref="audioPlayer" loop></audio>

        <template x-if="screen === 'api_key_input'">
            <div id="api-key-screen" x-cloak>
                <div class="max-w-xl mx-auto game-container relative p-8 rounded-lg pt-10 text-center">
                    <h1 class="game-title font-medieval">設定 API 金鑰</h1>
                    <p class="text-left text-gray-300 mb-4">
                        本遊戲的 AI 敘事功能（如序幕、誕生、繁衍故事）由 Google Gemini Pro 提供技術支援。為了使用這些功能，您需要一組自己的 API 金鑰。
                    </p>
                    <p class="text-left text-gray-300 mb-4">
                        您可以點擊下方連結免費取得。取得後，請將金鑰貼入輸入框中。
                    </p>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 hover:underline mb-4 inline-block">
                        前往 Google AI Studio 取得免費 API 金鑰
                    </a>

                    <input type="text" x-model="userApiKey" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2 mb-6" placeholder="請在此貼上您的 API 金鑰...">

                    <div class="flex justify-center space-x-4">
                        <button @click="submitApiKey()" class="btn btn-primary">儲存金鑰並開始遊戲</button>
                        <button @click="proceedToGame()" class="btn btn-secondary">跳過，直接開始</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">（金鑰將只會儲存在您的瀏覽器本機，不會上傳到任何伺服器。）</p>
                </div>
            </div>
        </template>

    <!-- 遊戲開場敘事畫面 -->
     <div> <template x-if="screen === 'intro'">
        <div id="intro-screen" x-cloak>
        <div class="max-w-3xl mx-auto game-container relative p-8 rounded-lg flex flex-col items-center pt-10">
            <h1 class="game-title font-medieval">序幕</h1>
            <div class="min-h-[300px] w-full flex items-center justify-center p-4 bg-black bg-opacity-20 rounded mb-4">
                <p class="text-lg leading-relaxed">
                    (陰沉的天空下著濛濛細雨，冰冷的泥土沾滿全身)<br>
                    <br>
                    我，一個在現代都市中，忽然結束生命的人，卻在睜開雙眼時，發現自己身處一個截然不同的世界。沒有高樓大廈，沒有霓虹燈火，只有一個荒蕪一人的部落。<br>
                    當我試圖撐起身體，映入眼簾的，是一雙粗糙的綠色手掌。<br>
                    <br>
                    「不，這不是我的手...」我開始低頭審視著自己<br>
                    <br>
                    鏡面般的水窪倒映出一個面目猙獰長著尖耳、獠牙的生物——哥布林。<br>
                    <br>
                    「最弱小的魔物？」一個在冒險者眼中等同於經驗值的存在。<br>
                    <br>
                    恐懼與絕望再次襲來，但在這荒涼的世界裡，沒有時間自怨自艾，一股原始的求生本能取代了所有負面情緒。<br>
                    我知道，在這個充滿敵意的世界，必須拋棄過去的一切，從零開始。<br>
                    沒有同伴，沒有退路，必須獨自面對。<br>
                    掠奪、繁衍，用最原始的方式在這片土地上掙扎求生，建立只屬於自己的哥布林王國。<br>
                    <br>
                    <br>
                    ====故事不是從勇者屠龍開始，而是從一隻哥布林====<br>
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>
                    ？？？？「祝zj6...u.3的...死j;6回ejo ...」<br>
                </p>
            </div>
            <button @click="screen = 'creation'" class="btn btn-primary">開始遊戲</button>
        </div>
    </div> </template>

    <!-- 角色創建畫面 -->
    <template x-if="screen === 'creation'">
        <div id="creation-screen" x-cloak>
        <div class="max-w-4xl mx-auto game-container relative p-8 rounded-lg pt-10">
            <h1 class="game-title font-medieval">創建你的哥布林王</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <input type="text" x-model="creation.name" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="哥布林名稱">
                    <input type="number" x-model.number="creation.height" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="身高">
                    <input type="number" x-model.number="creation.penisSize" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="王的雄風 (公分)">
                    <textarea x-model="creation.appearance" rows="4" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="外貌描述..."></textarea>
                </div>
                <div class="space-y-4">
                    <h2 class="text-xl font-bold text-center text-amber-200">能力點數</h2>
                    <p class="text-center mb-2">剩餘點數:
                        <span x-text="creation.pointsRemaining" :class="creation.pointsRemaining < 0 ? 'text-red-400' : 'text-green-400'"></span>
                    </p>
                    <p class="text-center text-yellow-400 h-6" x-text="creation.statWarningMessage"></p>
                    <template x-for="stat in Object.keys(creation.stats)" :key="stat">
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label class="font-bold capitalize" x-text="STAT_NAMES[stat]"></label>
                                <div class="flex items-center">
                                    <button @click="updateStat(stat, creation.stats[stat] - 1)" class="px-3 py-1 bg-gray-700 rounded-l-md">-</button>
                                    <input type="number" min="-10" max="999" x-model.number="creation.stats[stat]" @input="checkStatValue(stat, $event.target.value)" class="stat-input w-16 text-center bg-gray-800 border-y-2 border-gray-600 py-1">
                                    <button @click="updateStat(stat, creation.stats[stat] + 1)" class="px-3 py-1 bg-gray-700 rounded-r-md">+</button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            <div class="text-center mt-8 space-x-4">
                <button @click="createCharacter()" class="btn btn-primary text-xl">創建我的哥布林王</button>
                <button x-show="hasSaveFile" @click="loadGame()" class="btn btn-secondary text-xl">讀取進度</button>
            </div>
        </div>
    </template>

    <template x-if="screen === 'birth_narrative'">
        <div id="birth-narrative-screen" x-cloak>
            <div class="max-w-3xl mx-auto game-container relative p-8 rounded-lg flex flex-col items-center pt-10">
                
                <h1 class="game-title font-medieval">王的誕生</h1>
                
                <div class="min-h-[300px] w-full flex items-center justify-center p-4 bg-black bg-opacity-20 rounded mb-4">
                    <div x-show="modals.narrative.isAwaitingConfirmation" class="text-center">
                        <p class="mb-4">是否要使用 AI 生成您的誕生故事？<br>這將根據您創建的角色資訊生成一段獨特的背景描述。</p>
                        <button @click="generateBirthNarrative()" class="btn btn-primary">使用 AI 生成誕生故事</button>
                    </div>
                    <div x-show="modals.narrative.isLoading" class="loader"></div>
                    <p x-show="!modals.narrative.isLoading && !modals.narrative.isAwaitingConfirmation" x-html="modals.narrative.content" class="text-lg leading-relaxed"></p>
                </div>
                
                <button @click="screen = 'tutorial_query'" class="btn btn-primary">繼續</button>

            </div> </div>
    </template>

    <template x-if="screen === 'rebirth'">
        <div id="rebirth-screen" x-cloak>
        <div class="max-w-4xl mx-auto game-container relative p-8 rounded-lg pt-10">
            <h1 class="game-title font-medieval">哥布林王之重生</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <input type="text" x-model="rebirth.name" class="w-full bg-gray-900 border-2 border-gray-600 rounded px-3 py-2 text-gray-400" placeholder="哥布林名稱" disabled>
                    <input type="number" x-model.number="rebirth.height" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="身高">
                    <input type="number" x-model.number="rebirth.penisSize" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="王的雄風 (公分)">
                    <textarea x-model="rebirth.appearance" rows="4" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="外貌描述..."></textarea>
                </div>
                <div class="space-y-4">
                    <h2 class="text-xl font-bold text-center text-amber-200">重新分配能力</h2>
                    <p class="text-center mb-2">
                        剩餘點數: <span x-text="rebirth.pointsRemaining" :class="rebirth.pointsRemaining < 0 ? 'text-red-400' : 'text-green-400'"></span>
                        / 總點數: <span x-text="rebirth.totalPoints"></span>
                    </p>
                    <p class="text-center text-gray-400 h-6">（每項能力值至少需要 1 點）</p>
                    <template x-for="stat in Object.keys(rebirth.stats)" :key="stat">
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label class="font-bold capitalize" x-text="STAT_NAMES[stat]"></label>
                                <div class="flex items-center">
                                    <button @click="updateRebirthStat(stat, rebirth.stats[stat] - 1)" class="px-3 py-1 bg-gray-700 rounded-l-md">-</button>
                                    <input type="number" min="1" max="999" x-model.number="rebirth.stats[stat]" @input="updateRebirthStat(stat, $event.target.value)" class="stat-input w-16 text-center bg-gray-800 border-y-2 border-gray-600 py-1">
                                    <button @click="updateRebirthStat(stat, rebirth.stats[stat] + 1)" class="px-3 py-1 bg-gray-700 rounded-r-md">+</button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            <div class="text-center mt-8">
                <button @click="confirmRebirth()" class="btn btn-primary text-xl">確認重生</button>
            </div>
        </div>
    </template>

    <template x-if="screen === 'breeding_narrative'">
        <div id="breeding-narrative-screen" x-cloak>
            <div class="max-w-3xl mx-auto game-container relative p-8 rounded-lg flex flex-col items-center pt-10">
                <h1 class="game-title font-medieval">繁衍</h1>

                <div class="min-h-[300px] w-full flex items-center justify-center p-4 bg-black bg-opacity-20 rounded mb-4">
                    <div x-show="modals.narrative.isLoading" class="loader"></div>
                    <p x-show="!modals.narrative.isLoading" x-html="modals.narrative.content || '請選擇您的行動...'"></p>
                </div>

                <div class="w-full space-y-2">
                    <div class="grid grid-cols-3 gap-2">
                        <button @click="confirmAndStartBreedingNarrative()" class="btn btn-primary" :disabled="modals.narrative.hasBred || modals.narrative.isLoading">
                            使用 AI 敘事
                        </button>
                        <button @click="generateNarrativeSegment('繼續')" class="btn btn-secondary" :disabled="!modals.narrative.content || modals.narrative.hasBred || modals.narrative.isLoading">
                            繼續
                        </button>
                        <button @click="generateNarrativeSegment('將巨根挺入')" class="btn btn-secondary" :disabled="!modals.narrative.content || modals.narrative.hasBred || modals.narrative.isLoading">
                            將巨根挺入
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-2">
                        <button @click="confirmAndNarrateBreeding()" class="btn btn-info" :disabled="modals.narrative.hasBred || modals.narrative.isLoading">
                            繁衍 (觸發AI結局)
                        </button>
                        
                        <button x-show="modals.narrative.hasBred" @click="finalizeBreedingAndReturn()" class="btn btn-success">
                            返回部落畫面
                        </button>

                        <button x-show="!modals.narrative.hasBred" @click="executeQuickBreedingAndReturn()" class="btn btn-danger">
                            直接繁衍 (跳過敘事)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- 教學詢問畫面 -->
    <template x-if="screen === 'tutorial_query'">
    <div id="tutorial-query-screen" x-cloak>
        <div class="max-w-xl mx-auto game-container relative p-8 rounded-lg pt-10 text-center">
            <h1 class="game-title font-medieval">引導</h1>
            <p class="text-lg mb-6">王，您已降臨於此。本遊戲與您所知的可能不盡相同，初期將充滿挑戰。您需要基本的引導嗎？</p>
            <div class="flex justify-center space-x-4">
                <button @click="startTutorial(true)" class="btn btn-primary">是，我需要引導</button>
                <button @click="startTutorial(false)" class="btn btn-secondary">否，祝我在這世界玩得愉快</button>
            </div>
        </div>
    </div>
    </template>

    <!-- 主遊戲畫面 (部落中心) -->
    <template x-if="screen === 'tribe'">
        <div id="tribe-screen" x-cloak x-init="initializeTribe()">
            <template x-if="player && screen === 'tribe'">
                <div class="max-w-7xl mx-auto">
                    <div class="space-y-6">
    
                        <div class="game-container relative p-4 rounded-lg pt-10">
                            <h2 class="game-title font-medieval">王之號令</h2>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <button @click="handleRaidButtonClick()" class="btn btn-primary" :class="{ 'glow-pulse': tutorial.active && tutorial.step === 5 }">出擊掠奪</button>
                                <button @click="handleConstructionClick()" class="btn btn-primary" :class="{ 'glow-pulse': tutorial.active && tutorial.step === 2 }">部落建設</button>
                                <button @click="openMerchant()" class="btn btn-primary" :disabled="!merchant.isPresent" title="旅行商人來訪時才能進入">
                                    商人營地 <span x-show="merchant.isPresent" class="text-yellow-300">(來訪中)</span>
                                </button>
                                <button @click="openDispatchModal()" class="btn btn-primary">部落派遣</button>
                            </div>
                        </div>
    
                        <div class="game-container relative p-4 rounded-lg pt-10 h-full">
                            <h2 class="game-title font-medieval">王國總覽</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                                <div>
                                    <div class="flex gap-x-4">
                                        <div class="w-1/3 flex-shrink-0">
                                            <div class="w-full h-48 bg-gray-800 rounded flex items-center justify-center text-gray-500">
                                                <template x-if="player.avatarUrl">
                                                    <img :src="player.avatarUrl" class="w-full h-full object-cover rounded" alt="Player Avatar">
                                                </template>
                                                <template x-if="!player.avatarUrl">
                                                    <span>頭像</span>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="w-2/3 space-y-2">
                                            <p><strong>名稱:</strong> <span class="font-accent" x-text="player.name"></span></p>
                                            <p class="font-bold text-amber-200" :class="{'text-red-400': isStarving}">總能力值
                                                <span x-show="isStarving">(飢餓中 -25%)</span>:
                                            </p>
                                            <p class="text-sm"><strong>生命值:</strong>
                                                <span x-text="player.currentHp"></span> / <span x-text="player.calculateMaxHp(isStarving)"></span>
                                                <span class="text-green-400" x-show="player.getPartyHpBonus(isStarving) > 0" x-text="` (+${player.getPartyHpBonus(isStarving)})`"></span>
                                                <span class="text-blue-400" x-show="player.getEquipmentHpBonus() > 0" x-text="` (+${player.getEquipmentHpBonus()})`"></span>
                                            </p>
                                            <ul class="list-disc list-inside space-y-1 text-sm pt-1">
                                                <template x-for="stat in ['strength', 'agility', 'intelligence', 'luck']" :key="stat">
                                                    <li class="flex items-center justify-between">
                                                        <div>
                                                            <span class="capitalize" x-text="STAT_NAMES[stat]"></span>:
                                                            <span x-text="player.stats[stat]"></span>
                                                            <span class="text-yellow-400 font-bold" x-show="tempStatIncreases[stat] > 0" x-text="` (+${tempStatIncreases[stat]})`"></span>
                                                            <span class="text-green-400" x-show="player.getPartyBonus(stat) > 0" x-text="` (+${player.getPartyBonus(stat)})`"></span>
                                                            <template x-if="player.getSpecialAffixModifier(stat).bonus > 0">
                                                                <span class="text-purple-400" x-text="` (+${player.getSpecialAffixModifier(stat).bonus})`"></span>
                                                            </template>
                                                            <template x-if="player.getSpecialAffixModifier(stat).penalty > 0">
                                                                <span class="text-red-400" x-text="` (-${player.getSpecialAffixModifier(stat).penalty})`"></span>
                                                            </template>
                                                            <span class="text-blue-400" x-show="player.getEffectiveEquipmentBonus(stat) > 0" x-text="` (+${player.getEffectiveEquipmentBonus(stat)})`"></span>
                                                            <span class="text-red-400" x-show="isStarving" x-text="` -> ${player.getTotalStat(stat, isStarving)}`"></span>
                                                        </div>
                                                        <button @click="addTempPoint(stat)" x-show="player.attributePoints > 0 && (player.attributePoints - Object.values(tempStatIncreases).reduce((a, b) => a + b, 0)) > 0" class="btn btn-sm btn-primary ml-2 w-8" :class="{'glow-pulse': tutorial.active && !tutorial.finishedAttributePoints && player.attributePoints > 0}">+</button>
                                                    </li>
                                                </template>
                                            </ul>
                                            <div x-show="Object.values(tempStatIncreases).reduce((a, b) => a + b, 0) > 0" class="mt-2 text-right space-x-2">
                                                <button @click="confirmAttributePoints()" class="btn btn-sm btn-success">確認分配</button>
                                                <button @click="cancelAttributePoints()" class="btn btn-sm btn-secondary">取消</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-3 text-sm text-center border-y border-gray-700 py-1 my-2">
                                        <div>
                                            <span class="text-gray-400 block text-xs">天數</span>
                                            <span x-text="day"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400 block text-xs">能力點</span>
                                            <span x-text="player.attributePoints - Object.values(tempStatIncreases).reduce((a, b) => a + b, 0)"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400 block text-xs">技能點</span>
                                            <span x-text="player.skillPoints"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-4 mt-4 md:mt-0">
                                    <div>
                                        <p class="mt-4 font-bold text-amber-200 flex justify-between items-center">
                                            <span>當前裝備:</span>
                                            <button @click="openPlayerEquipment()" class="btn btn-xs btn-secondary">管理裝備</button>
                                        </p>
                                        <div class="space-y-1 text-sm">
                                            <template x-for="slot in Object.keys(player.equipment)" :key="slot">
                                                <div class="flex justify-between items-center">
                                                    <span class="capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></span>
                                                    <template x-if="player.equipment[slot]">
                                                        <div class="text-right">
                                                            <span :style="{ color: player.equipment[slot].quality.color }" x-text="player.equipment[slot].name"></span>
                                                            <button @click="unequipItem(slot, player)" class="btn btn-xs btn-secondary ml-2">卸下</button>
                                                        </div>
                                                    </template>
                                                    <template x-if="!player.equipment[slot]">
                                                        <span class="text-gray-500">-- 無 --</span>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-x-4 pt-4 mt-4 border-t border-gray-700">
                                        <div>
                                            <p class="font-bold text-amber-200">部落資源:</p>
                                            <ul class="list-disc list-inside ml-4 text-sm">
                                                <li>食物: <span x-text="resources.food"></span> / <span x-text="foodCapacity"></span></li>
                                                <li>木材: <span x-text="resources.wood"></span> / <span x-text="woodCapacity"></span></li>
                                                <li>礦石: <span x-text="resources.stone"></span> / <span x-text="stoneCapacity"></span></li>
                                            </ul>
                                        </div>
                                        <div>
                                            <p class="font-bold text-amber-200">部落人口:</p>
                                            <ul class="list-disc list-inside ml-4 text-sm">
                                                <li>夥伴: <span x-text="partners.length"></span> /
                                                    <span x-text="partnerCapacity"></span>
                                                </li>
                                                <li>俘虜: <span x-text="dungeonCaptives.length"></span> /
                                                    <span x-text="captiveCapacity"></span>
                                                </li>
                                                <li>孕母: <span x-text="mothers.length"></span> /
                                                    <span x-text="maternityCapacity"></span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>                      
    
                        <div class="game-container relative p-4 rounded-lg pt-10">
                            <h2 class="game-title font-medieval">部落日誌</h2>
                            <div class="log-panel" id="tribe" x-init="$watch('logs.tribe', () => { $nextTick(() => { $el.scrollTop = $el.scrollHeight }) })">
                                <template x-for="entry in logs.tribe" :key="entry.id">
                                    <div :class="`log-entry ${entry.type}`" x-html="entry.message"></div>
                                </template>
                            </div>
                        </div>

                        <div class="game-container relative p-4 rounded-lg pt-10">
                            <h2 class="game-title font-medieval">遊戲存檔</h2>
                            <div class="flex space-x-4">
                                <button @click="saveGame()" class="btn btn-primary">儲存進度</button>
                                <button x-show="hasSaveFile" @click="loadGame()" class="btn btn-secondary">讀取進度</button>
                                <button @click="exportGame()" class="btn btn-secondary">輸出存檔</button>
                            </div>
                            <div class="mt-4">
                                <textarea x-model="importSaveData" rows="4" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="請將備份的遊戲存檔貼到這裡..."></textarea>
                                <button @click="importGame()" class="btn btn-primary w-full mt-2">匯入存檔</button>
                            </div>
                        </div>

                        <div class="game-container relative p-4 rounded-lg pt-10">
                            <h2 class="game-title font-medieval">DLC 解鎖</h2>
                            <div class="flex space-x-2">
                                <input type="text" x-ref="dlc_code_input" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="請輸入 DLC 解鎖碼...">
                                <button @click="unlockDlc()" class="btn btn-primary">解鎖</button>
                            </div>
                            <p x-show="dlc.hells_knights" class="text-green-400 mt-2">「王國騎士團」DLC 已成功啟用！</p>
                        </div>
    
                        <div class="game-container relative p-4 rounded-lg pt-10">
                            <h2 class="game-title font-medieval">音樂設定</h2>
                            <div class="flex items-center space-x-4">
                                <label class="btn btn-secondary cursor-pointer">
                                    <span>選擇檔案</span>
                                    <input type="file" @change="loadMusic($event)" accept="audio/*" class="hidden">
                                </label>
                                <button @click="toggleMusic()" class="btn btn-primary w-24" :disabled="!musicSettings.src">
                                    <span x-text="musicSettings.isPlaying ? '暫停' : '播放'"></span>
                                </button>
                                <div>
                                    <label for="play-scene" class="text-sm mr-2">播放場景:</label>
                                    <select x-model="musicSettings.playOnScreen" id="play-scene" class="bg-gray-700 border-2 border-gray-600 rounded px-3 py-2">
                                        <option value="tribe">部落</option>
                                        <option value="raid_selection">掠奪選擇</option>
                                        <option value="raid">掠奪地圖</option>
                                        <option value="combat">戰鬥</option>
                                        <option value="throne_room">王座之間</option>
                                    </select>
                                </div>
                            </div>
                        </div>
    
                    </div>
                </div>
            </template>
        </div>
    </template>
    
        <!-- 掠奪選擇畫面 -->
        <template x-if="screen === 'raid_selection'">
            <div id="raid-selection-screen" x-cloak>
            <div class="max-w-2xl mx-auto game-container relative p-8 rounded-lg pt-10">
                <h1 class="game-title font-medieval">選擇掠奪目標</h1>
                <div class="space-y-4">
                    <template x-for="raid in raidOptions">
                        <button x-show="raid.difficulty !== 'hell' || dlc.hells_knights" @click="startRaid(raid.difficulty)" class="w-full text-left p-4 rounded-lg transition bg-gray-700 hover:bg-gray-600" :disabled="buildings.dungeon.level === 0" :class="{ 'glow-pulse': tutorial.active && tutorial.step === 5 && raid.difficulty === 'easy' }">    
                            <div>
                                <h3 class="text-xl font-bold" x-text="raid.name"></h3>
                                <p x-text="raid.description"></p>
                            </div>
                            <p x-show="buildings.dungeon.level === 0" class="text-red-400 text-sm mt-1">需要先建造地牢才能出擊！</p>
                        </button>
                    </template>
                </div>
                <div class="text-center mt-6">
                    <button @click="screen = 'tribe'" class="btn btn-secondary">返回部落</button>
                </div>
            </div>
        </template>

    <!-- 掠奪畫面 -->
    <template x-if="screen === 'raid'">
    <div id="raid-screen" x-cloak>
    <template x-if="currentRaid">
        <div class="flex flex-col lg:flex-row gap-6">

            <div class="flex-shrink-0 lg:w-1/3 space-y-6">
                <div class="game-container relative p-4 rounded-lg pt-10">
                    <h2 class="game-title font-medieval">掠奪指令</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button @click="scoutEnvironment()" class="btn btn-primary" :disabled="currentRaid.currentZone.scouted.environment" :class="{'glow-pulse': tutorial.active && tutorial.step === 4.5}">偵查環境</button>
                        <button @click="modals.raidStatus.isOpen = true" class="btn btn-secondary">查看狀態</button>

                        <button @click="modals.raidCaptives.isOpen = true" class="btn btn-secondary">查看俘虜</button>

                        <button @click="sneakPastGuards()" class="btn btn-primary" x-show="currentRaid.currentZoneIndex === 0 && currentRaid.currentZone.buildings.find(b => b.type === '衛兵所' && b.occupants.length > 0)">潛行繞過守軍</button>
                        <button @click="advanceToNextZone()" class="btn btn-secondary" :disabled="!canAdvance()">深入內城</button>
                        <button @click="handleRetreatAction()" class="btn btn-danger col-span-full">
                            <span x-text="currentRaid && currentRaid.currentZoneIndex > 0 ? '撤退回上層' : '脫離城鎮'"></span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-grow flex flex-col gap-6">
                <div class="game-container relative p-4 rounded-lg pt-10 flex-grow">
                    <h2 class="game-title font-medieval" x-text="(currentRaid?.currentZone?.name || '') + ' 地圖'"></h2>
                    <div 
                        class="map-container-responsive"
                        x-ref="mapContainer"
                        x-init="() => {
                            const observer = new ResizeObserver(() => {
                                if ($refs.mapContainer) {
                                    mapScale = $refs.mapContainer.offsetWidth / MAP_WIDTH;
                                }
                            });
                            observer.observe($refs.mapContainer);
                        }"
                    >
                        <div class="map-canvas" :style="`transform: scale(${mapScale});`">
                            <div class="relative bg-gray-800" :style="`width: ${MAP_WIDTH}px; height: ${MAP_HEIGHT}px;`">
                                <div class="absolute top-0 left-0 right-0 p-2 bg-black bg-opacity-40 text-center text-white">
                                    <span class="font-bold text-lg" x-text="currentRaid?.locationName"></span> | 
                                    <span>剩餘時間: </span>
                                    <span class="font-bold" :class="currentRaid?.timeRemaining < 30 ? 'text-red-400' : 'text-yellow-300'" x-text="currentRaid?.timeRemaining ?? 0"></span>
                                    <span> 分鐘</span>
                                </div>

                                <div class="absolute bottom-0 left-0 p-2 bg-black bg-opacity-40 text-white text-sm">
                                    <span>區域: </span>
                                    <span class="font-bold" x-text="currentRaid?.currentZone?.name"></span>
                                </div>

                                <div x-show="currentRaid.currentZone.scouted.environment" 
                                    class="absolute bottom-0 left-1/2 -translate-x-1/2 p-2 bg-black bg-opacity-40 text-white text-sm whitespace-nowrap">
                                    <span>區域資源: </span>
                                    <span class="text-green-400">食 <span x-text="currentRaid.currentZone.resources.food"></span></span> | 
                                    <span class="text-yellow-500">木 <span x-text="currentRaid.currentZone.resources.wood"></span></span> | 
                                    <span class="text-gray-400">礦 <span x-text="currentRaid.currentZone.resources.stone"></span></span>
                                </div>

                                <div class="absolute bottom-0 right-0 p-2 bg-black bg-opacity-40 text-white text-sm">
                                    <span>攜帶俘虜: </span>
                                    <span class="font-bold" x-text="currentRaid?.carriedCaptives.length ?? 0"></span> /
                                    <span class="font-bold" x-text="carryCapacity"></span>
                                </div>

                                <div x-show="currentRaid.currentZone.scouted.environment">
                                    <template x-for="building in currentRaid.currentZone.buildings" :key="building.id">
                                        <div @click="handleMapClick(building, $event)" class="absolute border-2 border-gray-500 bg-gray-700/50 flex flex-col items-center justify-center text-center p-1 cursor-pointer hover:border-yellow-400" :style="`left:${building.x}px; top:${building.y}px; width:${building.width}px; height:${building.height}px;`" :class="{'border-yellow-400': selectedTarget && selectedTarget.id === building.id}">
                                            <span class="text-xs leading-tight" x-text="building.type + building.postScoutText"></span>
                                        </div>
                                    </template>
                                    <template x-for="enemyGroup in currentRaid.currentZone.enemies" :key="enemyGroup[0].id">
                                        <div @click="handleMapClick(enemyGroup, $event)" class="absolute w-4 h-4 rounded-full border-2 border-black cursor-pointer transform -translate-x-1/2 -translate-y-1/2 hover:scale-150 transition-transform" :class="[getUnitColor(enemyGroup), {'ring-2 ring-offset-2 ring-offset-gray-800 ring-yellow-400': selectedTarget && selectedTarget[0] && selectedTarget[0].id === enemyGroup[0].id}]" :style="`left:${enemyGroup[0].x}px; top:${enemyGroup[0].y}px;`"></div>
                                    </template>
                                </div>
                                <div class="absolute w-5 h-5 rounded-full border-2 border-black transition-all duration-300" :class="getUnitColor(player)" :style="`left:${playerMapPosition.x}px; top:${playerMapPosition.y}px;`"></div>

                                <template x-if="selectedTarget">
                                    <div class="absolute bg-gray-900/80 p-2 rounded-lg border border-gray-600 space-y-2 z-10" :style="getInteractionMenuPosition()">

                                        <template x-if="Array.isArray(selectedTarget)">
                                            <button @click="scoutTarget(selectedTarget)" class="btn btn-xs btn-secondary w-full">偵查</button>
                                            <template x-if="isTargetScouted(selectedTarget[0].id)">
                                                <button @click="startCombat(selectedTarget)" class="btn btn-xs btn-danger w-full">攻擊</button>
                                            </template>
                                            <template x-if="selectedTarget.some(e => e.visual)">
                                                <button @click="executeSneakKidnapFromMap()" class="btn btn-xs btn-secondary w-full">潛行擄走</button>
                                            </template>
                                        </template>

                                        <template x-if="!Array.isArray(selectedTarget)">
                                            <button @click="executeBuildingScout(selectedTarget)" class="btn btn-xs btn-secondary w-full">偵查</button>
                                        </template>

                                    </div>
                                </template>

                            </div>
                        </div>
                    </div>
                </div>
                <div class="game-container relative p-4 rounded-lg pt-10">
                    <h2 class="game-title font-medieval">掠奪日誌</h2>
                    <div class="log-panel" id="raidl" x-init="$watch('logs.raid', () => { $nextTick(() => { $el.scrollTop = $el.scrollHeight }) })">
                        <template x-for="entry in logs.raid" :key="entry.id">
                            <div :class="`log-entry ${entry.type}`" x-html="entry.message"></div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </template>
    </div>
</template>

    <!-- 戰鬥畫面 -->
    <template x-if="screen === 'combat'">
        <div id="combat-screen" x-cloak>
        <div class="max-w-5xl mx-auto game-container relative p-6 rounded-lg pt-10">
            <h1 class="game-title font-medieval">戰鬥中</h1>
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-bold text-green-400">我方隊伍
                        (<span x-text="combat.allies.filter(u => u.isAlive()).length"></span>)</h3>
                    <div class="space-y-1 mt-2 text-sm">
                        <template x-for="unit in combat.allies">
                            <p :class="!unit.isAlive() ? 'text-gray-500 line-through' : ''">
                                <span x-text="unit.name"></span> - HP: <span x-text="unit.currentHp"></span> /
                                <span x-text="unit.maxHp"></span>
                            </p>
                        </template>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-red-400">敵方隊伍
                        (<span x-text="combat.enemies.filter(u => u.isAlive()).length"></span>)</h3>
                    <div class="space-y-1 mt-2 text-sm">
                        <template x-for="unit in combat.enemies">
                            <p :class="!unit.isAlive() ? 'text-gray-500 line-through' : ''">
                                <span x-text="unit.name"></span> (<span x-text="unit.profession"></span>) - HP:
                                <span x-text="unit.currentHp"></span> / <span x-text="unit.maxHp"></span>
                            </p>
                        </template>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <h3 class="font-bold">戰鬥紀錄</h3>
                <div class="log-panel" id="combat" x-init="$watch('logs.combat', () => { $nextTick(() => { $el.scrollTop = $el.scrollHeight }) })">
                    <template x-for="entry in logs.combat" :key="entry.id">
                        <div :class="`log-entry ${entry.type}`" x-html="entry.message"></div>
                    </template>
                </div>
            </div>
            <div class="mt-4 text-center space-x-4">
                <button @click="executePlayerAction('attack')" class="btn btn-primary" :disabled="!player || !player.isAlive() || combat.isProcessing || combat.playerActionTaken">普通攻擊</button>
                <button @click="executePlayerAction('escape')" class="btn btn-secondary" :disabled="!player || !player.isAlive() || combat.isProcessing || combat.playerActionTaken || combat.isReinforcementBattle || combat.isUnescapable">潛行脫離</button>
            </div>
        </div>
    </template>

    <!-- MODALS -->
    <template x-if="player">
        <div> <div class="modal" x-show="modals.dispatch.isOpen" x-cloak>
            <div class="modal-content !max-w-4xl game-container relative p-6 rounded-lg">
                <h2 class="game-title font-medieval">部落派遣</h2>
                <div class="pt-10 max-h-[80vh] overflow-y-auto">
                    <div class="flex border-b border-gray-600 mb-4">
                        <button @click="modals.dispatch.activeTab = 'hunting'" :class="{ 'bg-gray-700 text-white': modals.dispatch.activeTab === 'hunting' }" class="flex-1 py-2 px-4 rounded-t-lg">打獵 (食物)</button>
                        <button @click="modals.dispatch.activeTab = 'logging'" :class="{ 'bg-gray-700 text-white': modals.dispatch.activeTab === 'logging' }" class="flex-1 py-2 px-4 rounded-t-lg">伐木 (木材)</button>
                        <button @click="modals.dispatch.activeTab = 'mining'" :class="{ 'bg-gray-700 text-white': modals.dispatch.activeTab === 'mining' }" class="flex-1 py-2 px-4 rounded-t-lg">採礦 (礦石)</button>
                    </div>

                    <template x-for="task in ['hunting', 'logging', 'mining']" :key="task">
                        <div x-show="modals.dispatch.activeTab === task">
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-xl font-bold mb-2 text-amber-200">可派遣的哥布林</h3>
                                    <div class="space-y-2 h-96 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                        <template x-for="p in availablePartnersForDispatch" :key="p.id">
                                            <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                                <div>
                                                    <p class="font-bold" x-text="p.name"></p>
                                                    <p class="text-xs text-gray-400">力:<span x-text="p.stats.strength"></span> 敏:<span x-text="p.stats.agility"></span> 智:<span x-text="p.stats.intelligence"></span> 運:<span x-text="p.stats.luck"></span></p>

                                                    <p class="text-sm text-green-400 mt-1" x-show="modals.dispatch.activeTab === 'hunting'">
                                                        預計產量: <strong x-text="getGoblinYield(p, 'hunting')"></strong> 食物
                                                    </p>
                                                    <p class="text-sm text-yellow-500 mt-1" x-show="modals.dispatch.activeTab === 'logging'">
                                                        預計產量: <strong x-text="getGoblinYield(p, 'logging')"></strong> 木材
                                                    </p>
                                                    <p class="text-sm text-gray-400 mt-1" x-show="modals.dispatch.activeTab === 'mining'">
                                                        預計產量: <strong x-text="getGoblinYield(p, 'mining')"></strong> 礦石
                                                    </p>
                                                    </div>
                                                <button @click="assignToDispatch(p.id, task)" class="btn btn-sm btn-success">指派</button>
                                            </div>
                                        </template>
                                        <p x-show="availablePartnersForDispatch.length === 0" class="text-center text-gray-400">沒有可派遣的夥伴了。</p>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold mb-2 text-amber-200">
                                        <span x-text="{'hunting': '打獵隊', 'logging': '伐木隊', 'mining': '採礦隊'}[task]"></span>
                                        (<span x-text="dispatch[task].length"></span> / 10)
                                    </h3>
                                    <div class="space-y-2 h-96 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                        <template x-for="p in getDispatchedPartners(task)" :key="p.id">
                                            <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                                <div>
                                                    <p class="font-bold" x-text="p.name"></p>
                                                    <p class="text-xs text-gray-400">力:<span x-text="p.stats.strength"></span> 敏:<span x-text="p.stats.agility"></span> 智:<span x-text="p.stats.intelligence"></span> 運:<span x-text="p.stats.luck"></span></p>
                                                    
                                                    <p class="text-sm text-green-400 mt-1" x-show="modals.dispatch.activeTab === 'hunting'">
                                                        預計產量: <strong x-text="getGoblinYield(p, 'hunting')"></strong> 食物
                                                    </p>
                                                    <p class="text-sm text-yellow-500 mt-1" x-show="modals.dispatch.activeTab === 'logging'">
                                                        預計產量: <strong x-text="getGoblinYield(p, 'logging')"></strong> 木材
                                                    </p>
                                                    <p class="text-sm text-gray-400 mt-1" x-show="modals.dispatch.activeTab === 'mining'">
                                                        預計產量: <strong x-text="getGoblinYield(p, 'mining')"></strong> 礦石
                                                    </p>

                                                </div>
                                                <button @click="removeFromDispatch(p.id, task)" class="btn btn-sm btn-danger">解除</button>
                                            </div>
                                        </template>
                                        <p x-show="dispatch[task].length === 0" class="text-center text-gray-400">尚未指派任何哥布林。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div class="text-right mt-6">
                        <button @click="modals.dispatch.isOpen = false" class="btn btn-secondary">關閉</button>
                    </div>
                </div>
            </div>
                </div>

            <div class="modal" x-show="modals.construction.isOpen" x-cloak >
                <div class="modal-content game-container relative p-6 rounded-lg">
                    <h2 class="game-title font-medieval">部落建設</h2>
                    <div class="pt-10 max-h-[80vh] overflow-y-auto">
                        <div class="flex border-b border-gray-600 mb-4 overflow-x-auto">
                            <button @click="modals.construction.activeTab = 'dungeon'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'dungeon', 'glow-pulse': tutorial.active && tutorial.step === 3 }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">地牢</button>
                            <button @click="modals.construction.activeTab = 'barracks'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'barracks' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">寢室</button>
                            <button @click="modals.construction.activeTab = 'warehouse'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'warehouse' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">倉庫</button>
                            <button @click="modals.construction.activeTab = 'armory'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'armory' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">兵工廠</button>
                            <button @click="modals.construction.activeTab = 'maternity'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'maternity', 'glow-pulse': tutorial.active && tutorial.step === 4 }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">產房</button>
                            <button @click="modals.construction.activeTab = 'trainingGround'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'trainingGround' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">訓練場</button>
                            <button @click="modals.construction.activeTab = 'merchantCamp'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'merchantCamp' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">商人營地</button>
                        </div>

                        <div x-show="modals.construction.activeTab === 'dungeon'">
                            <div class="flex border-b border-gray-600 mb-4">
                                <button @click="modals.dungeon.subTab = 'manage'" :class="{ 'bg-gray-700 text-white': modals.dungeon.subTab === 'manage' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">管理俘虜</button>
                                <button @click="modals.dungeon.subTab = 'breed'" :class="{ 'bg-gray-700 text-white': modals.dungeon.subTab === 'breed', 'glow-pulse': tutorial.active && tutorial.step === 5 }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">繁衍後代</button>
                                <button @click="modals.dungeon.subTab = 'upgrade'" :class="{ 'bg-gray-700 text-white': modals.dungeon.subTab === 'upgrade', 'glow-pulse': tutorial.active && tutorial.step === 3 }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">升級</button>
                            </div>
                            <div x-show="modals.dungeon.subTab === 'manage'">
                            <h3 class="text-xl font-bold mb-2">管理俘虜</h3>
                                <p class="mb-4">目前俘虜: <span x-text="dungeonCaptives.length"></span> / <span x-text="captiveCapacity"></span></p>
                                <div class="space-y-4">
                                    <template x-for="captive in dungeonCaptives" :key="captive.id">
                                        <div class="p-3 border border-gray-600 rounded">
                                            <div class="flex justify-between items-start">
                                                <div><p class="text-lg font-bold text-amber-200"><span x-text="captive.name"></span> - <span x-text="captive.profession"></span></p></div>
                                                <div class="text-right text-sm"><p>魅力: <span class="font-bold" x-text="captive.stats.charisma"></span></p></div>
                                            </div>
                                            <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                                <div><strong>力量:</strong> <span x-text="captive.stats.strength"></span></div>
                                                <div><strong>敏捷:</strong> <span x-text="captive.stats.agility"></span></div>
                                                <div><strong>智力:</strong> <span x-text="captive.stats.intelligence"></span></div>
                                                <div><strong>運氣:</strong> <span x-text="captive.stats.luck"></span></div>
                                            </div>
                                            <div class="text-right mt-2"><button @click="releaseCaptive(captive.id)" class="btn btn-danger btn-sm">拋棄</button></div>
                                        </div>
                                    </template>
                                    <p x-show="dungeonCaptives.length === 0" class="text-center text-gray-400">地牢中沒有任何俘虜。</p>
                                </div>
                            </div>
                            <div x-show="modals.dungeon.subTab === 'breed'">
                                <h3 class="text-xl font-bold mb-2">繁衍後代</h3>
                                <p class="mb-4">選擇要繁衍的對象。每日剩餘次數: <span x-text="breedingChargesLeft"></span> / <span x-text="totalBreedingCharges"></span></p>
                                <div class="space-y-2">
                                    <template x-for="captive in dungeonCaptives" :key="captive.id">
                                        <label class="p-3 border border-gray-600 rounded block cursor-pointer hover:bg-gray-700 transition-colors">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-grow">
                                                    <p class="font-bold text-amber-200"><span x-text="captive.name"></span> (<span x-text="captive.profession"></span>)</p>
                                                    <p class="text-sm text-pink-400">魅力: <span x-text="captive.stats.charisma"></span></p>
                                                    
                                                    <template x-if="captive.visual">
                                                        <div class="mt-2 pt-2 border-t border-gray-700 text-xs text-gray-400 grid grid-cols-2 gap-x-3 gap-y-1">
                                                            <span>身高: <span x-text="captive.visual.height + ' cm'"></span></span>
                                                            <span>胸圍: <span x-text="captive.visual.bust"></span></span>
                                                            <span>髮色: <span x-text="captive.visual.hairColor"></span></span>
                                                            <span>髮型: <span x-text="captive.visual.hairStyle"></span></span>
                                                            <span>個性: <span x-text="captive.visual.personality"></span></span>
                                                        </div>
                                                    </template>
                                                </div>
                                                
                                                <div class="flex-shrink-0 ml-4">
                                                    <input type="checkbox" :value="captive.id" x-model="modals.dungeon.selectedBreedIds" @click.stop class="form-checkbox h-5 w-5 bg-gray-800 border-gray-500 text-green-500 focus:ring-green-500">
                                                </div>
                                            </div>
                                        </label>
                                    </template>
                                    <p x-show="dungeonCaptives.length === 0" class="text-center text-gray-400">沒有可繁衍的對象。</p>
                                </div>
                                <div class="text-center mt-4">
                                    <button @click="handleBreedingClick()"
                                            :disabled="modals.dungeon.selectedBreedIds.length === 0 || modals.dungeon.selectedBreedIds.length > breedingChargesLeft || (mothers.length + modals.dungeon.selectedBreedIds.length) > maternityCapacity || maternityCapacity === 0"
                                            class="btn btn-primary"
                                            :class="{'glow-pulse': tutorial.active && !tutorial.finishedIntro && dungeonCaptives.length > 0}">
                                        執行繁衍 (<span x-text="modals.dungeon.selectedBreedIds.length"></span>)
                                    </button>
                                    <p x-show="maternityCapacity === 0" class="text-red-400 text-sm mt-2">請先建造或升級產房！</p>
                                    <p x-show="maternityCapacity > 0 && mothers.length >= maternityCapacity" class="text-red-400 text-sm mt-2">產房已滿！</p>
                                </div>
                            </div>
                            <div x-show="modals.dungeon.subTab === 'upgrade'">
                                <h3 class="text-xl font-bold mb-2">升級地牢 (等級 <span x-text="buildings.dungeon.level"></span>)</h3>
                                <p class="text-sm text-gray-400 mb-4">增加俘虜容量上限。</p>
                                <template x-if="buildings.dungeon.level < 6">
                                    <div>
                                        <p class="text-sm">
                                            <span x-text="buildings.dungeon.level === 0 ? '建造花費:' : `升級至 ${buildings.dungeon.level + 1} 級花費:`"></span>
                                            <span x-text="getBuildingUpgradeCost('dungeon').wood"></span> 木材,
                                            <span x-text="getBuildingUpgradeCost('dungeon').stone"></span> 礦石
                                        </p>
                                        <button @click="upgradeBuilding('dungeon')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('dungeon')" :class="{'glow-pulse': tutorial.active && tutorial.step === 2}">
                                            <span x-text="buildings.dungeon.level === 0 ? '建造' : '升級'"></span>
                                        </button>
                                    </div>
                                </template>
                                <p x-show="buildings.dungeon.level >= 6" class="text-sm text-green-400 mt-2">地牢已達到最大等級！</p>
                            </div>
                        </div>
                        
                        <div x-show="modals.construction.activeTab === 'barracks'">
                            <div class="flex border-b border-gray-600 mb-4">
                                <button @click="modals.barracks.subTab = 'manage'" :class="{ 'bg-gray-700 text-white': modals.barracks.subTab === 'manage', 'glow-pulse': tutorial.active && !tutorial.finishedPartyMgmt && partners.length > 0 }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">管理夥伴</button>
                                <button @click="modals.barracks.subTab = 'upgrade'" :class="{ 'bg-gray-700 text-white': modals.barracks.subTab === 'upgrade' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">升級</button>
                            </div>
                            <div x-show="modals.barracks.subTab === 'manage'">
                                <h3 class="text-xl font-bold mb-2">管理夥伴</h3>
                                <p class="mb-2">選擇最多 20 名夥伴加入你的出擊隊伍。</p>
                                <p class="mb-4">目前夥伴: <span x-text="partners.length"></span> / <span x-text="partnerCapacity"></span> | 當前隊伍: <span x-text="player?.party.length || 0"></span> / 20</p>
                                <div class="space-y-2">
                                    <template x-for="p in availablePartnersForParty" :key="p.id">
                                        <div class="p-2 border border-gray-600 rounded">
                                            <label class="flex justify-between items-center cursor-pointer hover:bg-gray-700 p-1 rounded-t">
                                                <div>
                                                    <p class="font-bold text-amber-200" x-text="p.name"></p>
                                                    <div class="text-xs text-gray-400 grid grid-cols-2 gap-x-4">
                                                        <span>力:<span x-text="p.stats.strength"></span><span class="text-blue-400" x-show="p.getEquipmentBonus('strength') > 0" x-text="` (+${p.getEquipmentBonus('strength')})`"></span></span>
                                                        <span>敏:<span x-text="p.stats.agility"></span><span class="text-blue-400" x-show="p.getEquipmentBonus('agility') > 0" x-text="` (+${p.getEquipmentBonus('agility')})`"></span></span>
                                                        <span>智:<span x-text="p.stats.intelligence"></span><span class="text-blue-400" x-show="p.getEquipmentBonus('intelligence') > 0" x-text="` (+${p.getEquipmentBonus('intelligence')})`"></span></span>
                                                        <span>運:<span x-text="p.stats.luck"></span><span class="text-blue-400" x-show="p.getEquipmentBonus('luck') > 0" x-text="` (+${p.getEquipmentBonus('luck')})`"></span></span>
                                                    </div>
                                                    <p class="text-xs text-gray-400 mt-1">
                                                        <span>HP:</span>
                                                        <span x-text="p.calculateMaxHp(isStarving)"></span>
                                                        <span class="text-blue-400" x-show="p.getEquipmentBonus('hp') > 0" x-text="` (基礎 ${p.calculateMaxHp(isStarving) - p.getEquipmentBonus('hp')} + 裝備 ${p.getEquipmentBonus('hp')})`"></span>
                                                    </p>
                                                </div>
                                                <input type="checkbox" :value="p.id" x-model="modals.barracks.selectedPartyIds" class="form-checkbox h-5 w-5 bg-gray-800 border-gray-500 text-green-500 focus:ring-green-500" :disabled="!modals.barracks.selectedPartyIds.includes(p.id) && modals.barracks.selectedPartyIds.length >= 20">
                                            </label>
                                            <div class="text-right pt-2 border-t border-gray-700">
                                                <button @click="openPartnerEquipment(p.id)" class="btn btn-secondary btn-sm">裝備</button>
                                                <button @click="releasePartner(p.id)" class="btn btn-danger btn-sm">逐出部落</button>
                                            </div>
                                        </div>
                                    </template>
                                    <p x-show="partners.length === 0" class="text-center text-gray-400">沒有任何夥伴。</p>
                                </div>
                                <div class="text-center mt-4">
                                    <button @click="confirmPartySelection()" class="btn btn-primary">確認隊伍</button>
                                </div>
                            </div>
                            <div x-show="modals.barracks.subTab === 'upgrade'">
                                <h3 class="text-xl font-bold mb-2">升級寢室 (等級 <span x-text="buildings.barracks.level"></span>)</h3>
                                <p class="text-sm text-gray-400 mb-4">增加哥布林夥伴數量上限。</p>
                                <template x-if="buildings.barracks.level < 5">
                                    <div>
                                        <p class="text-sm">
                                            <span x-text="buildings.barracks.level === 0 ? '建造花費:' : `升級至 ${buildings.barracks.level + 1} 級花費:`"></span>
                                            
                                            <span x-show="getBuildingUpgradeCost('barracks').food > 0">
                                                <span x-text="getBuildingUpgradeCost('barracks').food"></span> 食物, 
                                            </span>
                                            
                                            <span x-text="getBuildingUpgradeCost('barracks').wood"></span> 木材,
                                            <span x-text="getBuildingUpgradeCost('barracks').stone"></span> 礦石
                                        </p>
                                        <button @click="upgradeBuilding('barracks')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('barracks')">
                                            <span x-text="buildings.barracks.level === 0 ? '建造' : '升級'"></span>
                                        </button>
                                    </div>
                                </template>
                                <p x-show="buildings.barracks.level >= 5" class="text-sm text-green-400 mt-2">寢室已達到最大等級！</p>
                            </div>
                        </div>

                        <div x-show="modals.construction.activeTab === 'warehouse'">
                            <div class="flex border-b border-gray-600 mb-4">
                                <button @click="modals.warehouse.subTab = 'manage'" :class="{ 'bg-gray-700 text-white': modals.warehouse.subTab === 'manage' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">裝備管理</button>
                                <button @click="modals.warehouse.subTab = 'upgrade'" :class="{ 'bg-gray-700 text-white': modals.warehouse.subTab === 'upgrade' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">升級</button>
                            </div>
                            <div x-show="modals.warehouse.subTab === 'manage'">
                                <div class="flex items-center space-x-2 mb-4 border-b border-gray-600 pb-3">
                                    <span class="font-bold text-sm text-gray-400">篩選類型:</span>
                                    <button @click="modals.warehouse.activeFilter = 'all'" class="btn btn-xs" :class="{ 'btn-primary': modals.warehouse.activeFilter === 'all', 'btn-secondary': modals.warehouse.activeFilter !== 'all' }">全部</button>
                                    <button @click="modals.warehouse.activeFilter = 'weapon'" class="btn btn-xs" :class="{ 'btn-primary': modals.warehouse.activeFilter === 'weapon', 'btn-secondary': modals.warehouse.activeFilter !== 'weapon' }">武器</button>
                                    <button @click="modals.warehouse.activeFilter = 'shield'" class="btn btn-xs" :class="{ 'btn-primary': modals.warehouse.activeFilter === 'shield', 'btn-secondary': modals.warehouse.activeFilter !== 'shield' }">盾牌</button>
                                    <button @click="modals.warehouse.activeFilter = 'armor'" class="btn btn-xs" :class="{ 'btn-primary': modals.warehouse.activeFilter === 'armor', 'btn-secondary': modals.warehouse.activeFilter !== 'armor' }">鎧甲</button>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold mb-2">部落倉庫 (<span x-text="filteredWarehouseInventory.length"></span> / <span x-text="warehouseCapacity"></span>)</h3>
                                    <div class="space-y-2 max-h-48 overflow-y-auto p-1 border border-gray-700 rounded mb-4">
                                        <template x-for="item in filteredWarehouseInventory" :key="item.id">
                                            <div class="p-3 border border-gray-600 rounded flex flex-col">
                                                <div class="w-full mb-2">
                                                    <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                                    <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                                </div>
                                                <div class="w-full flex space-x-2">
                                                    <button @click="moveToBackpack(item.id)" class="btn btn-sm btn-secondary flex-grow">移至背包</button>
                                                    <button @click="equipItem(item.id, player)" class="btn btn-sm btn-success flex-grow">裝備</button>
                                                    <button @click="decomposeItem(item.id)" class="btn btn-sm btn-danger flex-grow" :disabled="buildings.armory.level === 0" title="需要先建造兵工廠">分解</button>
                                                    <button @click="openDiscardConfirm(item.id)" class="btn btn-sm btn-secondary flex-grow">丟棄</button>
                                                </div>
                                            </div>
                                        </template>
                                        <p x-show="filteredWarehouseInventory.length === 0" class="text-center text-gray-400">你的倉庫是空的，或篩選結果為空。</p>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold mb-2">玩家背包 (<span x-text="filteredPlayerInventory.length"></span> / <span x-text="backpackCapacity"></span>)</h3>
                                    <div class="space-y-2 max-h-48 overflow-y-auto p-1 border border-gray-700 rounded">
                                        <template x-for="item in filteredPlayerInventory" :key="item.id">
                                            <div class="p-3 border border-gray-600 rounded flex flex-col">
                                                <div class="w-full mb-2">
                                                    <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                                    <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                                </div>
                                                <div class="w-full flex space-x-2">
                                                    <button @click="moveToWarehouse(item.id)" class="btn btn-sm btn-secondary flex-grow">移至倉庫</button>
                                                    <button @click="equipItem(item.id, player)" class="btn btn-sm btn-success flex-grow">裝備</button>
                                                    <button @click="decomposeItem(item.id)" class="btn btn-sm btn-danger flex-grow" :disabled="buildings.armory.level === 0" title="需要先建造兵工廠">分解</button>
                                                    <button @click="openDiscardConfirm(item.id)" class="btn btn-sm btn-secondary flex-grow">丟棄</button>
                                                </div>
                                            </div>
                                        </template>
                                        <p x-show="filteredPlayerInventory.length === 0" class="text-center text-gray-400">你的背包是空的，或篩選結果為空。</p>
                                    </div>
                                </div>
                            </div>
                            <div x-show="modals.warehouse.subTab === 'upgrade'">
                                <h3 class="text-xl font-bold mb-2">升級倉庫 (等級 <span x-text="buildings.warehouse.level"></span>)</h3>
                                <p class="text-sm text-gray-400 mb-4">增加倉庫和背包的儲存上限。</p>
                                <p class="mb-4">當前容量: 倉庫 <span x-text="warehouseCapacity"></span> / 背包 <span x-text="backpackCapacity"></span></p>
                                <template x-if="buildings.warehouse.level < 4">
                                    <div>
                                        <p class="text-sm">
                                            <span x-text="buildings.warehouse.level === 0 ? '建造花費:' : `升級至 ${buildings.warehouse.level + 1} 級花費:`"></span>
                                            <span x-text="getBuildingUpgradeCost('warehouse').wood"></span> 木材,
                                            <span x-text="getBuildingUpgradeCost('warehouse').stone"></span> 礦石
                                        </p>
                                        <button @click="upgradeBuilding('warehouse')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('warehouse')">
                                            <span x-text="buildings.warehouse.level === 0 ? '建造' : '升級'"></span>
                                        </button>
                                    </div>
                                </template>
                                <p x-show="buildings.warehouse.level >= 4" class="text-sm text-green-400 mt-2">倉庫已達到最大等級！</p>
                            </div>
                        </div>

                        <div x-show="modals.construction.activeTab === 'armory'">
                            <div class="flex border-b border-gray-600 mb-4">
                                <button @click="modals.armory.subTab = 'craft'" :class="{ 'bg-gray-700 text-white': modals.armory.subTab === 'craft' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">製作</button>
                                <button @click="modals.armory.subTab = 'upgrade'" :class="{ 'bg-gray-700 text-white': modals.armory.subTab === 'upgrade' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">升級</button>
                            </div>
                            <div x-show="modals.armory.subTab === 'craft'">
                                <h3 class="text-xl font-bold mb-2">製作裝備</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label>類型:</label>
                                        <select x-model="modals.armory.craftingType" class="bg-gray-700 border-2 border-gray-600 rounded px-3 py-2 w-full">
                                            <template x-for="type in craftableTypes" :key="type.baseName">
                                                <option :value="type.baseName" x-text="type.baseName"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div>
                                        <label>材質:</label>
                                        <select x-model="modals.armory.craftingMaterial" class="bg-gray-700 border-2 border-gray-600 rounded px-3 py-2 w-full">
                                            <template x-for="mat in availableMaterials" :key="mat.key">
                                                <option :value="mat.key" x-text="mat.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div x-show="modals.armory.craftingMaterial">
                                        <p>花費: <span x-text="getCraftingCost().amount"></span> <span x-text="getCraftingCost().type"></span></p>
                                    </div>
                                    <button @click="craftItem()" class="btn btn-primary w-full" :disabled="!canAffordCraft">製作</button>
                                </div>
                            </div>
                            <div x-show="modals.armory.subTab === 'upgrade'">
                                <h3 class="text-xl font-bold mb-2">升級兵工廠 (等級 <span x-text="buildings.armory.level"></span>)</h3>
                                <p class="text-sm text-gray-400 mb-4">解鎖可製作的材質等級，並提升裝備分解的資源返還率。</p>
                                <template x-if="buildings.armory.level < 4">
                                    <div>
                                        <p class="text-sm">
                                            <span x-text="buildings.armory.level === 0 ? '建造花費:' : `升級至 ${buildings.armory.level + 1} 級花費:`"></span>
                                            <span x-text="getBuildingUpgradeCost('armory').wood"></span> 木材,
                                            <span x-text="getBuildingUpgradeCost('armory').stone"></span> 礦石
                                        </p>
                                        <p class="text-sm mt-1">下一級分解返還率: <span x-text="['20%', '30%', '40%', '50%'][buildings.armory.level]"></span></p>
                                        <button @click="upgradeBuilding('armory')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('armory')">
                                            <span x-text="buildings.armory.level === 0 ? '建造' : '升級'"></span>
                                        </button>
                                    </div>
                                </template>
                                <p x-show="buildings.armory.level >= 4" class="text-sm text-green-400 mt-2">兵工廠已達到最大等級！</p>
                            </div>
                        </div>

                        <div x-show="modals.construction.activeTab === 'maternity'">
                            <div class="flex border-b border-gray-600 mb-4">
                                <button @click="modals.maternity.subTab = 'manage'" :class="{ 'bg-gray-700 text-white': modals.maternity.subTab === 'manage' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">管理孕母</button>
                                <button @click="modals.maternity.subTab = 'upgrade'" :class="{ 'bg-gray-700 text-white': modals.maternity.subTab === 'upgrade', 'glow-pulse': tutorial.active && tutorial.step === 4 }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">升級</button>
                            </div>
                            <div x-show="modals.maternity.subTab === 'manage'">
                                <h3 class="text-xl font-bold mb-2">管理孕母</h3>
                                <p class="mb-4">目前孕母: <span x-text="mothers.length"></span> / <span x-text="maternityCapacity"></span></p>
                                <div class="space-y-4">
                                    <template x-for="mother in mothers" :key="mother.id">
                                        <div class="p-3 border border-gray-600 rounded">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <p class="text-lg font-bold text-amber-200"><span x-text="mother.name"></span> - <span x-text="mother.profession"></span></p>
                                                    <p class="text-sm" :class="mother.isPregnant ? 'text-pink-400' : 'text-gray-400'" x-text="mother.isPregnant ? `懷孕中 (剩餘 ${mother.pregnancyTimer} 天)` : '產奶中'"></p>
                                                </div>
                                                <div class="text-right text-sm">
                                                    <p>魅力: <span class="font-bold" x-text="mother.stats.charisma"></span></p>
                                                </div>
                                            </div>
                                            <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                                <div><strong>力量:</strong> <span x-text="mother.stats.strength"></span></div>
                                                <div><strong>敏捷:</strong> <span x-text="mother.stats.agility"></span></div>
                                                <div><strong>智力:</strong> <span x-text="mother.stats.intelligence"></span></div>
                                                <div><strong>運氣:</strong> <span x-text="mother.stats.luck"></span></div>
                                            </div>
                                            <div class="text-right mt-2 space-x-2">
                                                <button @click="moveMotherToDungeon(mother.id)" class="btn btn-secondary btn-sm">移回地牢</button>
                                                <button @click="releaseCaptive(mother.id)" class="btn btn-danger btn-sm">拋棄</button>
                                            </div>
                                        </div>
                                    </template>
                                    <p x-show="mothers.length === 0" class="text-center text-gray-400">產房中沒有任何孕母。</p>
                                </div>
                            </div>
                            <div x-show="modals.maternity.subTab === 'upgrade'">
                                <h3 class="text-xl font-bold mb-2">升級產房 (等級 <span x-text="buildings.maternity.level"></span>)</h3>
                                <p class="text-sm text-gray-400 mb-4">增加孕母容量上限。</p>
                                <template x-if="buildings.maternity.level < 6">
                                    <div>
                                        <p class="text-sm">
                                            <span x-text="buildings.maternity.level === 0 ? '建造花費:' : `升級至 ${buildings.maternity.level + 1} 級花費:`"></span>
                                            <span x-text="getBuildingUpgradeCost('maternity').food"></span> 食物,
                                            <span x-text="getBuildingUpgradeCost('maternity').wood"></span> 木材,
                                            <span x-text="getBuildingUpgradeCost('maternity').stone"></span> 礦石
                                        </p>
                                        <button @click="upgradeBuilding('maternity')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('maternity')" :class="{'glow-pulse': tutorial.active && tutorial.step === 4}">
                                            <span x-text="buildings.maternity.level === 0 ? '建造' : '升級'"></span>
                                        </button>
                                    </div>
                                </template>
                                <p x-show="buildings.maternity.level >= 6" class="text-sm text-green-400 mt-2">產房已達到最大等級！</p>
                            </div>
                        </div>

                        <div x-show="modals.construction.activeTab === 'trainingGround'">
                            <template x-if="buildings.trainingGround.level === 0">
                                <div>  <h3 class="text-xl font-bold mb-2">建造訓練場</h3>
                                    <p class="text-sm text-gray-400 mb-4">建造一個設施來訓練你的哥布林夥伴，讓他們變得更強。</p>
                                    <div>
                                        <p class="text-sm">
                                            <span>建造成本:</span>
                                            <span x-text="getBuildingUpgradeCost('trainingGround').food"></span> 食物,
                                            <span x-text="getBuildingUpgradeCost('trainingGround').wood"></span> 木材,
                                            <span x-text="getBuildingUpgradeCost('trainingGround').stone"></span> 礦石
                                        </p>
                                        <button @click="upgradeBuilding('trainingGround')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('trainingGround')">
                                            <span>建造</span>
                                        </button>
                                    </div>
                                </div>
                            </template>

                            <template x-if="buildings.trainingGround.level > 0">
                                <div>
                                    <h3 class="text-xl font-bold mb-2">夥伴訓練</h3>
                                    <p class="mb-4 text-sm text-gray-400">選擇一名夥伴進行一對一訓練，將消耗一天時間。訓練將參考您<span class="text-yellow-400">自身原始能力</span>，為夥伴增加 <span class="font-bold text-green-400" x-text="potentialTrainingPoints"></span> 點隨機屬性。每位夥伴一生只能接受一次訓練。</p>
                                    <div class="space-y-4">
                                        <template x-for="p in partners" :key="p.id">
                                            <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                                <div>
                                                    <p class="text-lg font-bold text-amber-200" x-text="p.name"></p>
                                                    <p class="text-xs text-gray-400">力:<span x-text="p.stats.strength"></span> 敏:<span x-text="p.stats.agility"></span> 智:<span x-text="p.stats.intelligence"></span> 運:<span x-text="p.stats.luck"></span></p>
                                                </div>
                                                <button @click="executeTraining(p.id)" class="btn btn-sm btn-primary" :disabled="p.hasBeenTrained">
                                                    <span x-text="p.hasBeenTrained ? '已訓練' : '訓練'"></span>
                                                </button>
                                            </div>
                                        </template>
                                        <p x-show="partners.length === 0" class="text-center text-gray-400">你沒有任何夥伴可以訓練。</p>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div x-show="modals.construction.activeTab === 'merchantCamp'">
                            <h3 class="text-xl font-bold mb-2">升級商人營地 (等級 <span x-text="buildings.merchantCamp.level"></span>)</h3>
                            <p class="text-sm text-gray-400 mb-4">提升旅行商人販售的商品數量，並增加其停留時間。</p>
                            <template x-if="buildings.merchantCamp.level < 4">
                                <div>
                                    <p class="text-sm">
                                        <span x-text="buildings.merchantCamp.level === 0 ? '建造花費:' : `升級至 ${buildings.merchantCamp.level + 1} 級花費:`"></span>
                                        <span x-text="getBuildingUpgradeCost('merchantCamp').food"></span> 食物,
                                        <span x-text="getBuildingUpgradeCost('merchantCamp').wood"></span> 木材,
                                        <span x-text="getBuildingUpgradeCost('merchantCamp').stone"></span> 礦石
                                    </p>
                                    <p class="text-sm mt-1">下一級商品數量: <span x-text="[2, 4, 6, 8, 10][buildings.merchantCamp.level]"></span> -> <span class="text-green-400" x-text="[4, 6, 8, 10][buildings.merchantCamp.level]"></span></p>
                                    <p class="text-sm mt-1">下一級停留時間: <span x-text="1 + buildings.merchantCamp.level"></span> 天 -> <span class="text-green-400" x-text="2 + buildings.merchantCamp.level"></span> 天</p>
                                    <button @click="upgradeBuilding('merchantCamp')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('merchantCamp')">
                                        <span x-text="buildings.merchantCamp.level === 0 ? '建造' : '升級'"></span>
                                    </button>
                                </div>
                            </template>
                            <p x-show="buildings.merchantCamp.level >= 4" class="text-sm text-green-400 mt-2">商人營地已達到最大等級！</p>
                        </div>

                        <div class="text-right mt-6">
                            <button @click="modals.construction.isOpen = false" class="btn btn-secondary">關閉</button>
                        </div>
                    </div>
                </div>
                </div>

            </div>  </template>


    <!-- 偵查目標 Modal -->
    <div class="modal" x-show="modals.scoutInfo.isOpen" x-cloak>
        <template x-if="currentRaid && modals.scoutInfo.target">
            <div class="modal-content game-container relative p-6 rounded-lg">
                <h2 class="game-title font-medieval">偵查情報</h2>

                <div class="pt-10 max-h-[70vh] overflow-y-auto">
                    <template x-if="modals.scoutInfo.target.length > 0">
                        <div class="space-y-4">
                            <template x-for="unit in modals.scoutInfo.target" :key="unit.id">
                                <div class="p-3 border border-gray-700 rounded">
                                    <p class="text-lg font-bold text-amber-200"><span x-text="unit.name"></span> - <span x-text="unit.profession"></span></p>
                                    <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                        <div><strong>力量:</strong> <span x-text="unit.stats.strength"></span></div>
                                        <div><strong>敏捷:</strong> <span x-text="unit.stats.agility"></span></div>
                                        <div><strong>智力:</strong> <span x-text="unit.stats.intelligence"></span></div>
                                        <div><strong>運氣:</strong> <span x-text="unit.stats.luck"></span></div>
                                        <div class="col-span-2" x-show="unit.stats.charisma > 0"><strong>魅力:</strong> <span x-text="unit.stats.charisma"></span></div>
                                    </div>
                                    <div class="mt-2 pt-2 border-t border-gray-600 text-sm">
                                        <p class="font-bold text-amber-200">裝備:</p>
                                        <div class="space-y-1 pl-2">
                                            <template x-for="slot in Object.keys(unit.equipment || {})" :key="slot">
                                                <div>
                                                    <span class="capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></span>:
                                                    <template x-if="unit.equipment[slot]">
                                                        <span :style="{ color: unit.equipment[slot].quality.color }" x-text="unit.equipment[slot].name"></span>
                                                    </template>
                                                    <template x-if="!unit.equipment[slot]">
                                                        <span class="text-gray-500">-- 無 --</span>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    <template x-if="unit.visual">
                                        <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                            <div><strong>身高:</strong> <span x-text="unit.visual.height"></span> cm</div>
                                            <div><strong>年紀:</strong> <span x-text="unit.visual.age"></span></div>
                                            <div><strong>髮色:</strong> <span x-text="unit.visual.hairColor"></span></div>
                                            <div><strong>髮型:</strong> <span x-text="unit.visual.hairStyle"></span></div>
                                            <div><strong>胸圍:</strong> <span x-text="unit.visual.bust"></span></div>
                                            <div class="col-span-2"><strong>個性:</strong> <span x-text="unit.visual.personality"></span></div>
                                            <div class="col-span-2"><strong>服裝:</strong> <span x-text="unit.visual.clothing"></span></div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>

                    <template x-if="modals.scoutInfo.target.length === 0">
                        <p class="text-center text-lg py-8" x-text="modals.scoutInfo.emptyBuildingMessage"></p>
                    </template>
                </div>

                <div class="text-right mt-6 pt-4 border-t border-gray-600 space-x-2">
                    <template x-if="modals.scoutInfo.target && modals.scoutInfo.target.length > 0">
                        <button @click="startCombatFromScout(modals.scoutInfo.target)" class="btn btn-danger">攻擊</button>
                        <template x-if="(Array.isArray(modals.scoutInfo.target) && modals.scoutInfo.target.some(e => e.visual)) || (!Array.isArray(modals.scoutInfo.target) && modals.scoutInfo.target.visual)">
                            <button @click="executeSneakKidnapFromModal()" class="btn btn-secondary">潛行擄走</button>
                        </template>
                    </template>
                    <template x-if="modals.scoutInfo.target && modals.scoutInfo.target.length === 0 && selectedTarget && !Array.isArray(selectedTarget) && !selectedTarget.looted">
                        <button @click="lootBuildingFromModal()" class="btn btn-primary">搜刮建築</button>
                    </template>
                    <button @click.stop="closeScoutModalAndClearTarget()" class="btn btn-secondary">關閉</button>
                </div>
            </div>
        </template>
    </div>

    <!-- 掠奪俘虜管理 Modal -->
    <div class="modal" x-show="modals.raidCaptives.isOpen" x-cloak>
        <div class="modal-content game-container relative p-6 rounded-lg">
            <h2 class="game-title font-medieval">管理本次俘虜</h2>
            <div class="pt-10 max-h-[80vh] overflow-y-auto">

                <p class="mb-4 text-center">
                    <span>攜帶俘虜: </span>
                    <span class="font-bold" x-text="currentRaid?.carriedCaptives.length ?? 0"></span> /
                    <span class="font-bold" x-text="carryCapacity"></span>
                </p>

                <div class="space-y-4">
                    <template x-for="captive in currentRaid?.carriedCaptives || []" :key="captive.id">
                        <div class="p-3 border border-gray-600 rounded">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-lg font-bold text-amber-200">
                                        <span x-text="captive.name"></span> - <span x-text="captive.profession"></span>
                                    </p>
                                </div>
                                <div class="text-right text-sm">
                                    <p>魅力: <span class="font-bold" x-text="captive.stats.charisma"></span></p>
                                </div>
                            </div>
                            <div class="text-right mt-2">
                                <button @click="releaseCarriedCaptive(captive.id)" class="btn btn-danger btn-sm">釋放</button>
                            </div>
                        </div>
                    </template>
                    <p x-show="!currentRaid || currentRaid.carriedCaptives.length === 0" class="text-center text-gray-400">你尚未捕獲任何俘虜。</p>
                </div>
                <div class="text-right mt-6">
                    <button @click="modals.raidCaptives.isOpen = false" class="btn btn-secondary">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 統一俘虜管理 Modal -->
    <div class="modal" x-show="modals.captiveManagement.isOpen" x-cloak>
        <div class="modal-content game-container relative p-6 rounded-lg">
            <h2 class="game-title font-medieval" x-text="modals.captiveManagement.title"></h2>
            <div class="pt-10 max-h-[80vh] overflow-y-auto">
                <p class="mb-4">請選擇要保留的俘虜。上限: <span x-text="modals.captiveManagement.selectedIds.length"></span> /
                    <span x-text="modals.captiveManagement.limit"></span>
                </p>
                <div class="space-y-4">
                    <template x-for="captive in modals.captiveManagement.list" :key="captive.id">
                        <div class="p-3 border border-gray-600 rounded">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-lg font-bold text-amber-200"><span x-text="captive.name"></span> -
                                        <span x-text="captive.profession"></span>
                                    </p>
                                    <p class="text-sm">
                                        <span x-show="captive.isPregnant" class="text-pink-400 font-bold" x-text="`狀態: 懷孕中 (剩餘 ${captive.pregnancyTimer} 天)`"></span>
                                        <span x-show="!captive.isPregnant && captive.isMother" class="text-blue-400 font-bold">狀態: 產奶中</span>
                                        <span x-show="!captive.isPregnant && !captive.isMother" class="text-green-400 font-bold">狀態: 可繁衍</span>
                                    </p>
                                </div>
                                <input type="checkbox" :value="captive.id" x-model="modals.captiveManagement.selectedIds"
                                           :disabled="!modals.captiveManagement.selectedIds.includes(captive.id) && modals.captiveManagement.selectedIds.length >= modals.captiveManagement.limit"
                                           class="form-checkbox h-5 w-5 bg-gray-800 border-gray-500 text-green-500 focus:ring-green-500">
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                <div><strong>力量:</strong> <span x-text="captive.stats.strength"></span></div>
                                <div><strong>敏捷:</strong> <span x-text="captive.stats.agility"></span></div>
                                <div><strong>智力:</strong> <span x-text="captive.stats.intelligence"></span></div>
                                <div><strong>運氣:</strong> <span x-text="captive.stats.luck"></span></div>
                                <div class="col-span-2"><strong>魅力:</strong>
                                    <span class="font-bold" x-text="captive.stats.charisma"></span>
                                </div>
                            </div>
                            <template x-if="captive.visual">
                                <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                <div><strong>身高:</strong> <span x-text="captive.visual.height"></span> cm</div>
                                <div><strong>年紀:</strong> <span x-text="captive.visual.age"></span></div>
                                <div><strong>髮型:</strong> <span x-text="captive.visual.hair"></span></div>
                                    <div><strong>胸圍:</strong> <span x-text="captive.visual.bust"></span></div>
                                    <div class="col-span-2"><strong>個性:</strong>
                                        <span x-text="captive.visual.personality"></span>
                                    </div>
                                    <div class="col-span-2"><strong>服裝:</strong>
                                        <span x-text="captive.visual.clothing"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
                <div class="text-right mt-6">
                    <button @click="confirmCaptiveSelection()" class="btn btn-primary">
                        確認選擇 (<span x-text="modals.captiveManagement.selectedIds.length"></span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" x-show="modals.partnerManagement.isOpen" x-cloak>
        <div class="modal-content game-container relative p-6 rounded-lg">
            <h2 class="game-title font-medieval">寢室空間不足</h2>
            <div class="pt-10 max-h-[80vh] overflow-y-auto">
                <p class="mb-4">新生兒已誕生，但寢室已滿！您必須選擇要保留的夥伴。上限: <span x-text="modals.partnerManagement.selectedIds.length"></span> /
                    <span x-text="modals.partnerManagement.limit"></span>
                </p>
                <div class="space-y-4">
                    <template x-for="partner in modals.partnerManagement.list" :key="partner.id">
                        <div class="p-3 border rounded" :class="partner.id === modals.partnerManagement.newbornId ? 'border-yellow-400 bg-gray-700/50' : 'border-gray-600'">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-lg font-bold text-amber-200" x-text="partner.name"></p>
                                    <p class="text-sm text-yellow-400" x-show="partner.id === modals.partnerManagement.newbornId">（新生兒）</p>
                                </div>
                                <input type="checkbox" :value="partner.id" x-model="modals.partnerManagement.selectedIds"
                                           :disabled="!modals.partnerManagement.selectedIds.includes(partner.id) && modals.partnerManagement.selectedIds.length >= modals.partnerManagement.limit"
                                           class="form-checkbox h-5 w-5 bg-gray-800 border-gray-500 text-green-500 focus:ring-green-500">
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-700 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                <div><strong>力量:</strong> <span x-text="partner.stats.strength"></span></div>
                                <div><strong>敏捷:</strong> <span x-text="partner.stats.agility"></span></div>
                                <div><strong>智力:</strong> <span x-text="partner.stats.intelligence"></span></div>
                                <div><strong>運氣:</strong> <span x-text="partner.stats.luck"></span></div>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="text-right mt-6">
                    <button @click="confirmPartnerSelectionDecision()" class="btn btn-primary">
                        確認選擇 (<span x-text="modals.partnerManagement.selectedIds.length"></span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 繁衍敘事 Modal -->
    <div class="modal" x-show="modals.narrative.isOpen" x-cloak>
        <div class="modal-content game-container relative p-6 rounded-lg flex flex-col">
            <h2 class="game-title font-medieval" x-text="modals.narrative.title"></h2>
            <div class="pt-10 flex-grow flex flex-col max-h-[80vh]">
                <div class="flex-grow overflow-y-auto p-4 bg-black bg-opacity-20 rounded mb-4 flex items-center justify-center">

                    <div x-show="modals.narrative.type !== 'tutorial'" class="w-full">
                        <div x-show="modals.narrative.isAwaitingConfirmation" class="text-center">
                            <p class="mb-4" x-text="modals.narrative.content"></p>
                            <button x-show="modals.narrative.type === 'birth'" @click="generateBirthNarrative()" class="btn btn-primary">使用 AI 生成誕生故事</button>
                            <button x-show="modals.narrative.type === 'breeding'" @click="confirmAndStartBreedingNarrative()" class="btn btn-primary">使用 AI 生成繁衍敘事</button>
                        </div>

                        <div x-show="modals.narrative.isLoading" class="loader mx-auto"></div>

                        <p x-show="!modals.narrative.isLoading && !modals.narrative.isAwaitingConfirmation" x-html="modals.narrative.content"
                            class="text-lg leading-relaxed whitespace-pre-wrap w-full"></p>
                    </div>

                    <div x-show="modals.narrative.type === 'tutorial'" class="flex items-start gap-4 w-full">
                        <img src="https://i.ibb.co/k2QBgcHP/century-avatar.png" alt="世紀的頭像" class="w-24 h-24 rounded-full border-2 border-pink-400 flex-shrink-0">
                        <div class="flex-grow text-left" x-html="modals.narrative.content">
                            </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button x-show="modals.narrative.type === 'tutorial'" @click="closeNarrativeModal()" class="btn btn-primary">了解</button>
                </div>
                
                </div>
        </div>
    </div>

    <!-- 自訂提示框 -->
    <div x-show="modals.customAlert.isOpen" class="modal" @click.self="confirmCustomAlert()">
        <div class="modal-content game-container relative p-6 rounded-lg max-w-sm pt-10">
            <p class="text-center" x-text="modals.customAlert.message"></p>
            <div class="text-center mt-4">
                <button @click="confirmCustomAlert()" class="btn btn-primary">確定</button>
            </div>
        </div>
    </div>

    <!-- 丟棄確認 Modal -->
    <div x-show="modals.discardConfirm.isOpen" class="modal" >
        <div class="modal-content game-container relative p-6 rounded-lg max-w-sm pt-10">
            <p class="text-center">確定要丟棄 <span class="font-bold" x-text="modals.discardConfirm.itemName"></span> 嗎？<br>此操作無法復原。
            </p>
            <div class="text-center mt-6 flex justify-center space-x-4">
                <button @click="executeDiscardItem()" class="btn btn-danger">確定</button>
                <button @click="modals.discardConfirm.isOpen = false" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <!-- Raid Status Modal -->
     <template x-if="currentlyEditingPartner">
        <div class="modal" x-show="modals.partnerEquipment.isOpen" x-cloak >
            <div class="modal-content !max-w-4xl game-container relative p-6 rounded-lg">
                <h2 class="game-title font-medieval" x-text="`管理裝備 - ${currentlyEditingPartner.name}`"></h2>
                <div class="pt-10 max-h-[80vh] overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 space-y-4">
                            <h3 class="text-xl font-bold text-amber-200">已裝備</h3>
                            <template x-for="slot in Object.keys(currentlyEditingPartner.equipment)" :key="slot">
                                <div class="p-2 border border-gray-700 rounded">
                                    <p class="font-bold capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></p>
                                    <template x-if="currentlyEditingPartner.equipment[slot]">
                                        <div>
                                            <p :style="{ color: currentlyEditingPartner.equipment[slot].quality.color }" x-text="currentlyEditingPartner.equipment[slot].name"></p>
                                            <p class="text-xs text-gray-400" x-html="getItemStatsString(currentlyEditingPartner.equipment[slot])"></p>
                                            <button @click="unequipItem(slot, currentlyEditingPartner)" class="btn btn-sm btn-secondary mt-1">卸下</button>
                                        </div>
                                    </template>
                                    <template x-if="!currentlyEditingPartner.equipment[slot]">
                                        <p class="text-gray-500">-- 空 --</p>
                                    </template>
                                </div>
                            </template>
                        </div>

                        <div class="md:col-span-2 space-y-4">
                            <div class="flex items-center space-x-2 mb-4 border-b border-gray-600 pb-3">
                                <span class="font-bold text-sm text-gray-400">篩選類型:</span>
                                <button @click="modals.partnerEquipment.activeFilter = 'all'" class="btn btn-xs" :class="{ 'btn-primary': modals.partnerEquipment.activeFilter === 'all', 'btn-secondary': modals.partnerEquipment.activeFilter !== 'all' }">全部</button>
                                <button @click="modals.partnerEquipment.activeFilter = 'weapon'" class="btn btn-xs" :class="{ 'btn-primary': modals.partnerEquipment.activeFilter === 'weapon', 'btn-secondary': modals.partnerEquipment.activeFilter !== 'weapon' }">武器</button>
                                <button @click="modals.partnerEquipment.activeFilter = 'shield'" class="btn btn-xs" :class="{ 'btn-primary': modals.partnerEquipment.activeFilter === 'shield', 'btn-secondary': modals.partnerEquipment.activeFilter !== 'shield' }">盾牌</button>
                                <button @click="modals.partnerEquipment.activeFilter = 'armor'" class="btn btn-xs" :class="{ 'btn-primary': modals.partnerEquipment.activeFilter === 'armor', 'btn-secondary': modals.partnerEquipment.activeFilter !== 'armor' }">鎧甲</button>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold mb-2 text-amber-200">部落倉庫 (<span x-text="filteredPartnerWarehouse.length"></span> / <span x-text="warehouseCapacity"></span>)</h3>
                                    <div class="space-y-2 max-h-60 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                        <template x-for="item in filteredPartnerWarehouse" :key="item.id">
                                        <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                            <div>
                                                <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                                <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                            </div>
                                            <button @click="equipItem(item.id, currentlyEditingPartner)" class="btn btn-sm btn-success">裝備</button>
                                        </div>
                                    </template>
                                    <p x-show="filteredPartnerWarehouse.length === 0" class="text-center text-gray-400">倉庫是空的，或篩選結果為空。</p>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold mb-2 text-amber-200">玩家背包 (<span x-text="filteredPartnerBackpack.length"></span> / <span x-text="backpackCapacity"></span>)</h3>
                                <div class="space-y-2 max-h-60 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                    <template x-for="item in filteredPartnerBackpack" :key="item.id">
                                        <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                            <div>
                                                <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                                <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                            </div>
                                            <button @click="equipItem(item.id, currentlyEditingPartner)" class="btn btn-sm btn-success">裝備</button>
                                        </div>
                                    </template>
                                    <p x-show="filteredPartnerBackpack.length === 0" class="text-center text-gray-400">你的背包是空的，或篩選結果為空。</p>
                                </div>
                            </div>
                            </div>
                    </div>
                     <div class="text-right mt-6">
                        <button @click="modals.partnerEquipment.isOpen = false" class="btn btn-secondary">關閉</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template x-if="player">
        <div class="modal" x-show="modals.raidStatus.isOpen" x-cloak >
            <div class="modal-content game-container relative p-6 rounded-lg">
                <h2 class="game-title font-medieval">玩家狀態</h2>
                <div class="pt-10 max-h-[80vh] overflow-y-auto">
                    <div class="flex border-b border-gray-600 mb-4">
                        <button @click="modals.raidStatus.activeTab = 'status'" :class="{ 'bg-gray-700 text-white': modals.raidStatus.activeTab === 'status' }" class="flex-1 py-2 px-4 rounded-t-lg">狀態</button>
                        <button @click="modals.raidStatus.activeTab = 'partners'" :class="{ 'bg-gray-700 text-white': modals.raidStatus.activeTab === 'partners' }" class="flex-1 py-2 px-4 rounded-t-lg">夥伴</button> <button @click="modals.raidStatus.activeTab = 'equipment'" :class="{ 'bg-gray-700 text-white': modals.raidStatus.activeTab === 'equipment' }" class="flex-1 py-2 px-4 rounded-t-lg">裝備</button>
                        <button @click="modals.raidStatus.activeTab = 'inventory'" :class="{ 'bg-gray-700 text-white': modals.raidStatus.activeTab === 'inventory' }" class="flex-1 py-2 px-4 rounded-t-lg">背包</button>
                    </div>
                    <!-- Status Tab -->
                    <div x-show="modals.raidStatus.activeTab === 'status'">
                        <p><strong>名稱:</strong> <span class="font-accent" x-text="player.name"></span></p>
                        <p class="mt-2 font-bold text-amber-200" :class="{'text-red-400': isStarving}">總能力值
                        <span x-show="isStarving">(飢餓中 -25%)</span>:
                    </p>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <template x-for="stat in ['strength', 'agility', 'intelligence', 'luck']" :key="stat">
                            <li>
                                <div>
                                    <span class="capitalize" x-text="STAT_NAMES[stat]"></span>:
                                    <span x-text="player.stats[stat]"></span>
                                    <span class="text-green-400" x-show="player.getPartyBonus(stat) > 0" x-text="` (+${player.getPartyBonus(stat)})`"></span>
                                    
                                    <template x-if="player.getSpecialAffixModifier(stat).bonus > 0">
                                        <span class="text-purple-400" x-text="` (+${player.getSpecialAffixModifier(stat).bonus})`"></span>
                                    </template>
                                    <template x-if="player.getSpecialAffixModifier(stat).penalty > 0">
                                        <span class="text-red-400" x-text="` (-${player.getSpecialAffixModifier(stat).penalty})`"></span>
                                    </template>
                                    
                                    <span class="text-blue-400" x-show="player.getEffectiveEquipmentBonus(stat) > 0" x-text="` (+${player.getEffectiveEquipmentBonus(stat)})`"></span>
                                    <span class="text-red-400" x-show="isStarving" x-text="` -> ${player.getTotalStat(stat, isStarving)}`"></span>
                                </div>
                            </li>
                        </template>
                    </ul>
                        <div class="mt-2">
                            <p><strong>生命值:</strong>
                                <span x-text="player.currentHp"></span> / <span x-text="player.calculateMaxHp(isStarving)"></span>
                                <span class="text-green-400" x-show="player.getPartyHpBonus(isStarving) > 0" x-text="` (+${player.getPartyHpBonus(isStarving)})`"></span>
                                <span class="text-blue-400" x-show="player.getEquipmentHpBonus() > 0" x-text="` (+${player.getEquipmentHpBonus()})`"></span>
                            </p>
                        </div>
                    </div>
                    <!-- partners Tab -->
                    <div x-show="modals.raidStatus.activeTab === 'partners'" class="space-y-4">
                        <template x-for="partner in player.party" :key="partner.id">
                            <div class="p-3 border border-gray-700 rounded">
                                <p class="font-bold text-amber-200" x-text="partner.name"></p>
                                <p><strong>生命值:</strong> <span x-text="partner.currentHp"></span> / <span x-text="partner.calculateMaxHp(isStarving)"></span></p>
                                <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                    <template x-for="stat in ['strength', 'agility', 'intelligence', 'luck']" :key="stat">
                                        <div>
                                            <span class="capitalize" x-text="STAT_NAMES[stat]"></span>:
                                            <span x-text="partner.getTotalStat(stat, isStarving)"></span>
                                        </div>
                                    </template>
                                </div>
                                <div class="mt-2 pt-2 border-t border-gray-600 space-y-1 text-sm">
                                    <p class="font-bold text-amber-200">裝備:</p>
                                    <template x-for="slot in Object.keys(partner.equipment)" :key="slot">
                                        <div>
                                            <span class="capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></span>:
                                            <span x-show="partner.equipment[slot]" :style="{ color: partner.equipment[slot]?.quality.color }" x-text="partner.equipment[slot]?.name"></span>
                                            <span x-show="!partner.equipment[slot]" class="text-gray-500">-- 無 --</span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                        <p x-show="!player.party || player.party.length === 0" class="text-center text-gray-400">你沒有帶任何夥伴同行。</p>
                    </div>    
                    <!-- equipment Tab -->    
                    <div x-show="modals.raidStatus.activeTab === 'equipment'">
                            <div class="grid grid-cols-2 gap-4">
                                <template x-for="slot in Object.keys(player.equipment)" :key="slot">
                                    <div class="p-2 border border-gray-700 rounded">
                                        <p class="font-bold capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></p>
                                        <template x-if="player.equipment[slot]">
                                            <div>
                                                <p :style="{ color: player.equipment[slot].quality.color }"
                                                    x-text="player.equipment[slot].name"></p>
                                                <p class="text-xs text-gray-400"
                                                    x-html="getItemStatsString(player.equipment[slot])"></p>
                                                <button @click="unequipItem(slot, player)" class="btn btn-sm btn-secondary mt-1">卸下</button>
                                            </div>
                                        </template>
                                        <template x-if="!player.equipment[slot]">
                                            <p class="text-gray-500">-- 空 --</p>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    <!-- Inventory Tab -->
                    <div x-show="modals.raidStatus.activeTab === 'inventory'">
                        <div class="space-y-2">
                            <template x-for="item in player.inventory" :key="item.id">
                                <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                    <div>
                                        <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                        <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                    </div>
                                    <div class="space-x-2">
                                        <button @click="equipItem(item.id, player)" class="btn btn-sm btn-success">裝備</button>
                                        <button @click="decomposeItem(item.id)" class="btn btn-sm btn-danger" :disabled="buildings.armory.level === 0" title="需要先建造兵工廠">分解</button>
                                        <button @click="openDiscardConfirm(item.id)" class="btn btn-sm btn-secondary">丟棄</button>
                                    </div>
                                </div>
                            </template>
                            <p x-show="player.inventory.length === 0" class="text-center text-gray-400">你的背包是空的。</p>
                        </div>
                    </div>
                    <div class="text-right mt-6">
                        <button @click="modals.raidStatus.isOpen = false" class="btn btn-secondary">關閉</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    </template> <div class="modal" x-show="modals.merchant.isOpen" x-cloak >
    <div class="modal-content !max-w-4xl game-container relative p-6 rounded-lg">
        <h2 class="game-title font-medieval">旅行商人：世紀</h2>
        <div class="pt-10 max-h-[80vh] overflow-y-auto">
            <div class="flex items-start p-4 mb-6 bg-black bg-opacity-20 rounded-lg border border-pink-500/30">
                <img src="https://i.ibb.co/k2QBgcHP/century-avatar.png" alt="世紀的頭像" class="w-24 h-24 rounded-full border-2 border-pink-400 mr-4 flex-shrink-0">
                <div class="flex-grow">
                    <h3 class="text-xl font-bold text-pink-300">旅行商人：世紀</h3>
                    <p class="mt-2 text-pink-200 italic" x-text="merchant.dialogue"></p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-bold mb-2 text-amber-200">商品列表 (剩餘 <span x-text="merchant.goods.length"></span> 件)</h3>
                    <div class="space-y-2 h-96 overflow-y-auto pr-2">
                        <template x-for="item in merchant.goods" :key="item.id">
                            <label class="p-3 border rounded flex items-center justify-between cursor-pointer"
                                :class="merchant.selectedItemIds.includes(item.id) ? 'border-yellow-400 bg-gray-700' : 'border-gray-600 hover:bg-gray-600'">
                                <div>
                                    <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                    <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                    <p class="text-sm font-bold text-yellow-400 mt-1">價值: <span x-text="calculateEquipmentValue(item)"></span></p>
                                </div>
                                <input type="checkbox" :value="item.id" x-model="merchant.selectedItemIds"
                                    class="form-checkbox h-5 w-5 bg-gray-800 border-gray-500 text-yellow-500 focus:ring-yellow-500">
                            </label>
                        </template>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-bold mb-2 text-amber-200">你的貨幣 (俘虜)</h3>
                     <div class="space-y-2 h-96 overflow-y-auto pr-2">
                        <template x-for="captive in dungeonCaptives" :key="captive.id">
                            <label class="p-3 border rounded flex items-center justify-between cursor-pointer"
                                   :class="merchant.selectedCaptiveIds.includes(captive.id) ? 'border-green-400 bg-gray-700' : 'border-gray-600 hover:bg-gray-600'">
                                <div>
                                    <p x-text="captive.name"></p>
                                    <p class="text-xs text-gray-400">魅力: <span x-text="captive.stats.charisma"></span></p>
                                    <p class="text-sm font-bold text-green-400 mt-1">價值: <span x-text="calculateCaptiveValue(captive)"></span></p>
                                </div>
                                <input type="checkbox" :value="captive.id" x-model="merchant.selectedCaptiveIds"
                                       class="form-checkbox h-5 w-5 bg-gray-800 border-gray-500 text-green-500 focus:ring-green-500">
                            </label>
                        </template>
                         <p x-show="dungeonCaptives.length === 0" class="text-center text-gray-400">你沒有任何俘虜可以交易。</p>
                    </div>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-600 flex justify-between items-center">
                <div>
                    <p>商品價值: <span class="font-bold text-yellow-400" x-text="selectedItemsValue"></span></p>
                    <p>俘虜總價值: <span class="font-bold" :class="selectedCaptivesValue >= selectedItemsValue ? 'text-green-400' : 'text-red-400'" x-text="selectedCaptivesValue"></span></p>
                </div>
                <button @click="executeTrade()" class="btn btn-primary" :disabled="!canExecuteTrade">確認交易</button>
            </div>

            <div class="text-right mt-6">
                <button @click="modals.merchant.isOpen = false" class="btn btn-secondary">關閉</button>
            </div>
            </div>
    </div>
</div>
</template> 

<!-- 王座之間畫面 (2D場景版) -->
    <template x-if="screen === 'throne_room'">
        <div id="throne-room-screen-scene" x-cloak>
            <div class="w-full max-w-2xl mx-auto game-container relative p-6 rounded-lg pt-10">
                <h1 class="game-title font-medieval">王座之間</h1>
                <div class="text-center mb-4">
                    <p class="text-lg text-amber-200">公主與她的守護騎士們擋在了你的面前。</p>
                </div>

                <!-- 場景容器 -->
                <div class="scene-container" x-init="
                    const scene = $el;
                    for (let i = 0; i < 30; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'dust-particle';
                        const size = Math.random() * 3 + 1;
                        particle.style.width = `${size}px`;
                        particle.style.height = `${size}px`;
                        particle.style.top = `${Math.random() * 100}%`;
                        particle.style.left = `${Math.random() * 100}%`;
                        particle.style.setProperty('--tx', `${(Math.random() - 0.5) * 200}px`);
                        particle.style.setProperty('--ty', `${(Math.random() - 0.5) * 200}px`);
                        particle.style.animationDelay = `${Math.random() * 20}s`;
                        particle.style.animationDuration = `${Math.random() * 10 + 15}s`;
                        scene.appendChild(particle);
                    }
                ">
                    <!-- 周邊石柱 -->
                    <div class="pillar" style="top: 15%; left: 15%;"></div>
                    <div class="pillar" style="top: 15%; right: 15%;"></div>
                    <div class="pillar" style="bottom: 15%; left: 15%;"></div>
                    <div class="pillar" style="bottom: 15%; right: 15%;"></div>
                    <div class="pillar" style="top: 50%; left: 5%; transform: translateY(-50%);"></div>
                    <div class="pillar" style="top: 50%; right: 5%; transform: translateY(-50%);"></div>

                    <!-- 圓形場地 -->
                    <div class="arena-floor">
                        
                        <!-- 王座 -->
                        <div class="throne" style="top: 10%; left: 50%;"></div>

                        <!-- 動態生成公主 (黃點) -->
                        <template x-for="(unit, index) in throneRoomUnits.filter(u => u.profession === '公主')" :key="unit.id">
                            <div @click="scoutThroneUnit(unit)" class="unit princess" :style="`top: 20%; left: ${45 + (index * 10)}%;`"></div>
                        </template>

                        <!-- 動態生成騎士 (橘點) -->
                        <template x-for="unit in throneRoomUnits.filter(u => u.profession !== '公主')" :key="unit.id">
                            <div @click="scoutThroneUnit(unit)" class="unit knight" :style="`top: ${knightPositions[unit.profession].top}; left: ${knightPositions[unit.profession].left};`"></div>
                        </template>

                        <!-- 玩家 (綠點) -->
                        <div class="unit player" style="top: 90%; left: 50%;"></div>
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <button @click="screen = 'raid'" class="btn btn-danger">撤退回王城</button>
                </div>
            </div>
        </div>
    </template>
    
    <div class="modal" x-show="modals.throneScout.isOpen" x-cloak>
        <template x-if="modals.throneScout.unit">
            <div class="modal-content game-container relative p-6 rounded-lg">
                <h2 class="game-title font-medieval" x-text="`偵查情報 - ${modals.throneScout.unit.name}`"></h2>
    
                <div class="pt-10 max-h-[70vh] overflow-y-auto">
                    <p class="italic text-center text-pink-300 mb-4" x-text="getThroneUnitDialogue(modals.throneScout.unit)"></p>
                    
                    <div class="p-3 border border-gray-700 rounded">
                        <p class="text-lg font-bold text-amber-200">
                            <span x-text="modals.throneScout.unit.name"></span> - <span x-text="modals.throneScout.unit.profession"></span>
                        </p>
                        <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                            <div><strong>力量:</strong> <span x-text="modals.throneScout.unit.stats.strength"></span></div>
                            <div><strong>敏捷:</strong> <span x-text="modals.throneScout.unit.stats.agility"></span></div>
                            <div><strong>智力:</strong> <span x-text="modals.throneScout.unit.stats.intelligence"></span></div>
                            <div><strong>運氣:</strong> <span x-text="modals.throneScout.unit.stats.luck"></span></div>
                            <div class="col-span-2" x-show="modals.throneScout.unit.stats.charisma > 0">
                                <strong>魅力:</strong> <span class="font-bold text-lg text-pink-400" x-text="modals.throneScout.unit.stats.charisma"></span>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-600 text-sm">
                            <p class="font-bold text-amber-200">裝備:</p>
                            <div class="space-y-1 pl-2">
                                <template x-for="slot in Object.keys(modals.throneScout.unit.equipment || {})" :key="slot">
                                    <div>
                                        <span class="capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></span>:
                                        <template x-if="modals.throneScout.unit.equipment[slot]">
                                            <span :style="{ color: modals.throneScout.unit.equipment[slot].quality.color }" x-text="modals.throneScout.unit.equipment[slot].name"></span>
                                        </template>
                                        <template x-if="!modals.throneScout.unit.equipment[slot]">
                                            <span class="text-gray-500">-- 無 --</span>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
    
                <div class="text-right mt-6 pt-4 border-t border-gray-600 space-x-2">
                    <button @click="startFinalBattle()" class="btn btn-danger">發起決戰</button>
                    <button @click="modals.throneScout.isOpen = false" class="btn btn-secondary">關閉</button>
                </div>
            </div>
        </template>
    </div>
    
    <div class="modal" x-show="modals.itemManagement.isOpen" x-cloak>
        <div class="modal-content !max-w-3xl game-container relative p-6 rounded-lg">
            <h2 class="game-title font-medieval" x-text="modals.itemManagement.title"></h2>
            <div class="pt-10 max-h-[80vh] overflow-y-auto">
                <div class="p-4 mb-4 bg-gray-900/50 border border-yellow-500/30 rounded-lg text-center">
                    <p x-text="modals.itemManagement.message"></p>
                    <p class="mt-2">
                        <span>待處理裝備: </span>
                        <span class="font-bold text-lg" :class="modals.itemManagement.items.length > modals.itemManagement.capacity ? 'text-red-400' : 'text-green-400'" x-text="modals.itemManagement.items.length"></span>
                        <span> / </span>
                        <span class="font-bold text-lg text-green-400" x-text="modals.itemManagement.capacity"></span>
                    </p>
                </div>

                <div class="space-y-3">
                    <template x-for="item in modals.itemManagement.items" :key="item.id">
                        <div class="p-3 border border-gray-600 rounded flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="flex-grow">
                                <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                            </div>
                            <div class="flex-shrink-0 flex items-center gap-2">
                                <button @click="executeItemManagementAction('decompose', item.id)" class="btn btn-sm btn-danger" :disabled="buildings.armory.level === 0" title="需要先建造兵工廠">分解</button>
                                <button @click="executeItemManagementAction('discard', item.id)" class="btn btn-sm btn-secondary">丟棄</button>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="text-center mt-6 pt-4 border-t border-gray-700">
                    <button @click="confirmItemManagement()" class="btn btn-primary" :disabled="modals.itemManagement.items.length > modals.itemManagement.capacity">
                        確認處理
                    </button>
                </div>
            </div>
        </div>
    </div>
        <template x-if="modals.bailoutConfirm.isOpen">
            <div class="modal" @click.self="modals.bailoutConfirm.isOpen = false">
                <div class="modal-content game-container relative p-6 rounded-lg max-w-sm pt-10">
                    <p class="text-center text-lg" x-text="modals.bailoutConfirm.messages[modals.bailoutConfirm.currentMessageIndex]"></p>
                    <div class="text-center mt-6 flex justify-center space-x-4">
                        <button @click="confirmBailoutStep()" class="btn btn-danger">是</button>
                        <button @click="refuseBailout()" class="btn btn-secondary">否</button>
                    </div>
                </div>
            </div>
        </template>
<script src="js/00_constants_and_utils.js"></script>
<script src="js/01_classes.js"></script>
<script src="js/02_game_logic.js"></script>
<script src="js/game.js"></script>
<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('game', game);
  });
</script>
</div></body>
</html>
